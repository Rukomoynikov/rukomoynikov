<!DOCTYPE html>
<html lang="en" class="astro-EQOTTOWI">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width">
    <link rel="icon" type="image/x-icon" href="/favicon/favicon.ico">
    <link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png">
    <link rel="manifest" href="/favicon/site.webmanifest">
    <link rel="mask-icon" href="/favicon/safari-pinned-tab.svg" color="#5bbad5">

    <!-- SEO --><meta property="og:type" content="website">

<meta name="apple-mobile-web-app-title" content="Max Rukomoynikov's site">
<meta property="og:site_name" content="Max Rukomoynikov's site">

<title>How to make a Telegram bot in Elixir</title>
<meta property="og:title" content="How to make a Telegram bot in Elixir">
<meta name="twitter:title" content="How to make a Telegram bot in Elixir">

<meta property="og:image" content="/_image/assets/images/posts/elixir-telegram-bot/facebook-share_1200x630.jpg">
<meta property="og:image:alt" content="This is the first part of three in the series. There you will find creating foundation and answering to users.">
<meta name="twitter:image:src" content="/_image/assets/images/posts/elixir-telegram-bot/facebook-share_1200x630.jpg">

<meta name="twitter:card" content="summary_large_image">

<meta name="description" property="og:description" content="This is the first part of three in the series. There you will find creating foundation and answering to users.">
<meta name="twitter:description" content="This is the first part of three in the series. There you will find creating foundation and answering to users.">
<!-- /SEO -->

  <link rel="stylesheet" href="/assets/03ac1450.fdac69c5.css" />
<link rel="stylesheet" href="/assets/41ae0bfb.b7c6e526.css" />
<link rel="stylesheet" href="/assets/adcb6cd4.270ab3e3.css" />
<link rel="stylesheet" href="/assets/ac57aff7.4d0cf59c.css" />
<link rel="stylesheet" href="/assets/posts-elixir-telegram-bot-posts-rails-on-docker.0a37325d.css" /></head>
  <body class=" astro-EQOTTOWI">
    <div class="header astro-R3D7EQX5">
  <a href="/" class="logo astro-R3D7EQX5">
    Maxim<br class="astro-R3D7EQX5">Rukomoynikov
  </a>
  <div class="slogan astro-R3D7EQX5">
    I love to create. Developer and designer. Looking forward to make cool
    things.
  </div>
  <div class="links astro-R3D7EQX5">
    <a class="link astro-R3D7EQX5" href="https://twitter.com/Rukomoynikov">twitter</a>
    <a class="link astro-R3D7EQX5" href="https://www.facebook.com/rukomoynikov">facebook</a>
    <a class="link astro-R3D7EQX5" href="https://www.behance.net/ruq">behance</a>
  </div>
</div>


    <div class="content astro-EQOTTOWI">
      <div class="hero-title astro-ZQJ3ZA7Q">
  <div class="hero-title__container astro-ZQJ3ZA7Q">
    <div class="hero-title__text-container astro-ZQJ3ZA7Q">
      <div class="hero-title__tag astro-ZQJ3ZA7Q">Telegram</div><div class="hero-title__tag astro-ZQJ3ZA7Q">Elixir</div>
      <h2 class="hero-title__title astro-ZQJ3ZA7Q">
        How to make a Telegram bot in Elixir
      </h2>
      
    </div>
  </div>
</div>

<div class="container--1200 astro-BBNM3MM2">
  <h2 class=" astro-3KQXSL4C">Introduction to Telegram Bots API</h2>

<h3 class=" astro-3KQXSL4C">Exchanging messages with Telegram</h3>

<div class="columns standard astro-QMDQII75">
  <div class="col-1 astro-QMDQII75"><p class="paragraph astro-IOL3HG2G">
  
        Telegram supports two types of integration: webhooks and polling.
        Webhooks it's a type when Telegram sends request to your server whenever
        bot recevied a message from the user. There pros and cons of that type
        of integration. Webhooks are more sustainable in general. For webhooks
        it's necessary to have web-server with external IP adress. This server
        will receive new messages through get requests from Telegram. During
        development you can use ngrock.
      
</p>



<!-- <style type="text/css">
  .article-layout {
    display: flex;
  }
  @media only screen and (max-width: 595px) {
    .article-layout {
      flex-direction: column;
    }
  }
  .article-layout__text {
    display: flex;
    margin-right: 42px;
  }
  .article-layout__quotes {
    display: flex;
    font-size: 15px;
  }
</style> --></div>
  <div class="col-2 astro-QMDQII75"></div>
</div>

<div class="columns standard astro-QMDQII75">
  <div class="col-1 astro-QMDQII75"><p class="paragraph astro-IOL3HG2G">
  
        Polling is a constant polling of the Telegram server for new messages.
        For polling, you do not need a server and an external address. Simple
        application that sends requests to the Telegram server without stopping
        is enough.
      
</p>



<!-- <style type="text/css">
  .article-layout {
    display: flex;
  }
  @media only screen and (max-width: 595px) {
    .article-layout {
      flex-direction: column;
    }
  }
  .article-layout__text {
    display: flex;
    margin-right: 42px;
  }
  .article-layout__quotes {
    display: flex;
    font-size: 15px;
  }
</style> --></div>
  <div class="col-2 astro-QMDQII75"><ul class="links-list astro-SIOEHDSZ">
  <li class="astro-SIOEHDSZ">
        <a href="https://core.telegram.org/bots/api#getting-updates" class="links-list__link astro-SIOEHDSZ">
          Documentation about Telegram bots
        </a>
      </li>
</ul>

</div>
</div>

<h3 class=" astro-3KQXSL4C">Obtaining a token from Telegram</h3>

<div class="columns standard astro-QMDQII75">
  <div class="col-1 astro-QMDQII75"><p class="paragraph astro-IOL3HG2G">
  
        The token for Telegram requests must be obtained from the BotFather bot.
      
</p>



<!-- <style type="text/css">
  .article-layout {
    display: flex;
  }
  @media only screen and (max-width: 595px) {
    .article-layout {
      flex-direction: column;
    }
  }
  .article-layout__text {
    display: flex;
    margin-right: 42px;
  }
  .article-layout__quotes {
    display: flex;
    font-size: 15px;
  }
</style> --></div>
  <div class="col-2 astro-QMDQII75"></div>
</div>

<div class="columns standard astro-QMDQII75">
  <div class="col-1 astro-QMDQII75"><video controls loop class="post__video astro-7FVP5DK2">
  <source src="/videos/posts/elixir-telegram-bot/api_token.mp4" type="video/mp4" class="astro-7FVP5DK2">
</video>

</div>
  <div class="col-2 astro-QMDQII75"><ul class="links-list astro-SIOEHDSZ">
  <li class="astro-SIOEHDSZ">
        <a href="https://t.me/botfather" class="links-list__link astro-SIOEHDSZ">
          BotFather
        </a>
      </li>
</ul>

</div>
</div>

<h2 class=" astro-3KQXSL4C">Elixir</h2>

<div class="columns standard astro-QMDQII75">
  <div class="col-1 astro-QMDQII75"><p class="paragraph astro-IOL3HG2G">
  
        Elixir is a functional programming language. Based on the another
        programming language Erlang. The main advantage of Elixir is the ability
        to manage a huge number of processes. These processes are also made in a
        special way, so they take up significantly less memory and processor
        time than normal computer processes.
      
</p>



<!-- <style type="text/css">
  .article-layout {
    display: flex;
  }
  @media only screen and (max-width: 595px) {
    .article-layout {
      flex-direction: column;
    }
  }
  .article-layout__text {
    display: flex;
    margin-right: 42px;
  }
  .article-layout__quotes {
    display: flex;
    font-size: 15px;
  }
</style> --></div>
  <div class="col-2 astro-QMDQII75"><ul class="links-list astro-SIOEHDSZ">
  <li class="astro-SIOEHDSZ">
        <a href="https://elixir-lang.org/install.html" class="links-list__link astro-SIOEHDSZ">
          How to install Elixir one elixir-lang.org
        </a>
      </li><li class="astro-SIOEHDSZ">
        <a href="https://gist.github.com/mikoscz/4d2a0052d4cdaaa027bc8a8d6af1e817" class="links-list__link astro-SIOEHDSZ">
          Installing with asdf package manager
        </a>
      </li>
</ul>

</div>
</div>

<h2 class=" astro-3KQXSL4C">The application</h2>

<div class="columns standard astro-QMDQII75">
  <div class="col-1 astro-QMDQII75"><p class="paragraph astro-IOL3HG2G">
  
        I will gradually complicate the application. I'll start with a echo bot
        that sends a message back in response to a message. Next, I will add
        saving users to the database. And in the end, I'll try to make it a
        little useful - upon request from the user, the bot will send summary
        information about the stock market.
      
</p>



<!-- <style type="text/css">
  .article-layout {
    display: flex;
  }
  @media only screen and (max-width: 595px) {
    .article-layout {
      flex-direction: column;
    }
  }
  .article-layout__text {
    display: flex;
    margin-right: 42px;
  }
  .article-layout__quotes {
    display: flex;
    font-size: 15px;
  }
</style> --></div>
  <div class="col-2 astro-QMDQII75"></div>
</div>

<h3 class=" astro-3KQXSL4C">Creation of the skeleton of the application and installation of the
      necessary tools</h3>

<div class="columns standard astro-QMDQII75">
  <div class="col-1 astro-QMDQII75"><div class="code-snippet astro-L4T6MRF5">
  
  <pre class="astro-code" style="background-color: #ffffff; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;"><code><span class="line"><span style="color: #393a34">mix new stocks_bot --sup</span></span></code></pre>

</div>

</div>
  <div class="col-2 astro-QMDQII75"></div>
</div>

<div class="columns standard astro-QMDQII75">
  <div class="col-1 astro-QMDQII75"><p class="paragraph astro-IOL3HG2G">
  
        First you need to create a new application. The <i class="astro-4LCKIGOU">--sup</i>

 option adds a supervisor to the application and starts it at startup. After
        creation, the structure of the application should look like this:
      
</p>



<!-- <style type="text/css">
  .article-layout {
    display: flex;
  }
  @media only screen and (max-width: 595px) {
    .article-layout {
      flex-direction: column;
    }
  }
  .article-layout__text {
    display: flex;
    margin-right: 42px;
  }
  .article-layout__quotes {
    display: flex;
    font-size: 15px;
  }
</style> --></div>
  <div class="col-2 astro-QMDQII75"></div>
</div>

<div class="columns standard astro-QMDQII75">
  <div class="col-1 astro-QMDQII75"><div class="code-snippet astro-L4T6MRF5">
  
  <pre class="astro-code" style="background-color: #ffffff; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;"><code><span class="line"><span style="color: #393a34"></span></span>
<span class="line"><span style="color: #393a34">        ├── README.md ├── lib │ ├── stocks_bot │ │ └── application.ex │ └──</span></span>
<span class="line"><span style="color: #393a34">        stocks_bot.ex ├── mix.exs └── test ├── stocks_bot_test.exs └──</span></span>
<span class="line"><span style="color: #393a34">        test_helper.exs</span></span>
<span class="line"><span style="color: #393a34">      </span></span></code></pre>

</div>

</div>
  <div class="col-2 astro-QMDQII75"></div>
</div>

<div class="columns standard astro-QMDQII75">
  <div class="col-1 astro-QMDQII75"><p class="paragraph astro-IOL3HG2G">
  
        Additionally, you need to install HTTPoison to send requests and Jason
        to work with JSON in responses from the Telegram server.
      
</p>



<!-- <style type="text/css">
  .article-layout {
    display: flex;
  }
  @media only screen and (max-width: 595px) {
    .article-layout {
      flex-direction: column;
    }
  }
  .article-layout__text {
    display: flex;
    margin-right: 42px;
  }
  .article-layout__quotes {
    display: flex;
    font-size: 15px;
  }
</style> --></div>
  <div class="col-2 astro-QMDQII75"></div>
</div>

<div class="columns standard astro-QMDQII75">
  <div class="col-1 astro-QMDQII75"><div class="code-snippet astro-L4T6MRF5">
  <div class="file-name"><img class="code-block__file-icon" src="/assets/file-2.ad06406a.svg"/>stocks_bot/mix.exs</div>
  <pre class="astro-code" style="background-color: #ffffff; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;"><code><span class="line"></span>
<span class="line"><span style="color: #AB5959">..</span><span style="color: #999999">.</span></span>
<span class="line"></span>
<span class="line"><span style="color: #1E754F">defp</span><span style="color: #393A34"> </span><span style="color: #59873A">deps</span><span style="color: #393A34"> </span><span style="color: #1E754F">do</span></span>
<span class="line"><span style="color: #393A34">  </span><span style="color: #999999">[</span></span>
<span class="line"><span style="color: #393A34">    </span><span style="color: #999999">{:</span><span style="color: #A65E2B">httpoison</span><span style="color: #999999">,</span><span style="color: #393A34"> </span><span style="color: #B56959AA">&quot;</span><span style="color: #B56959">~&gt; 1.8</span><span style="color: #B56959AA">&quot;</span><span style="color: #999999">},</span></span>
<span class="line"><span style="color: #393A34">    </span><span style="color: #999999">{:</span><span style="color: #A65E2B">jason</span><span style="color: #999999">,</span><span style="color: #393A34"> </span><span style="color: #B56959AA">&quot;</span><span style="color: #B56959">~&gt; 1.2</span><span style="color: #B56959AA">&quot;</span><span style="color: #999999">}</span></span>
<span class="line"><span style="color: #393A34">  </span><span style="color: #999999">]</span></span>
<span class="line"><span style="color: #1E754F">end</span></span>
<span class="line"><span style="color: #393A34">      </span></span></code></pre>

</div>

</div>
  <div class="col-2 astro-QMDQII75"></div>
</div>

<h3 class=" astro-3KQXSL4C">Receiving user message</h3>

<div class="columns standard astro-QMDQII75">
  <div class="col-1 astro-QMDQII75"><div class="code-snippet astro-L4T6MRF5">
  <div class="file-name"><img class="code-block__file-icon" src="/assets/file-2.ad06406a.svg"/>stocks_bot/lib/stocks_bot.ex</div>
  <pre class="astro-code" style="background-color: #ffffff; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;"><code><span class="line"></span>
<span class="line"><span style="color: #1E754F">defmodule</span><span style="color: #393A34"> </span><span style="color: #2E808F">StocksBot</span><span style="color: #393A34"> </span><span style="color: #1E754F">do</span></span>
<span class="line"><span style="color: #393A34">  </span><span style="color: #999999">@</span><span style="color: #B07D48">basic_url</span><span style="color: #393A34"> </span><span style="color: #B56959AA">&quot;</span><span style="color: #B56959">https://api.telegram.org/bot&lt;Токен от Botfather&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #B56959">  def get_updates(offset </span><span style="color: #A65E2B">\ </span><span style="color: #B56959">nil) do</span></span>
<span class="line"><span style="color: #B56959">    with {:ok, %HTTPoison.Response{status_code: 200, body: body}} =</span></span>
<span class="line"><span style="color: #B56959">           updates_url(offset) |&gt; HTTPoison.get(),</span></span>
<span class="line"><span style="color: #B56959">         {:ok, data} = Jason.decode(body) do</span></span>
<span class="line"><span style="color: #B56959">      IO.inspect(data[</span><span style="color: #B56959AA">&quot;</span><span style="color: #393A34">result</span><span style="color: #B56959AA">&quot;</span><span style="color: #B56959">])</span></span>
<span class="line"><span style="color: #B56959">    end</span></span>
<span class="line"><span style="color: #B56959">  end</span></span>
<span class="line"></span>
<span class="line"><span style="color: #B56959">  defp updates_url(_offset = nil) do</span></span>
<span class="line"><span style="color: #B56959">    @basic_url &lt;&gt; </span><span style="color: #B56959AA">&quot;</span><span style="color: #393A34">getUpdates</span><span style="color: #B56959AA">&quot;</span></span>
<span class="line"><span style="color: #B56959">  end</span></span>
<span class="line"><span style="color: #B56959">end</span></span>
<span class="line"><span style="color: #B56959">      </span></span></code></pre>

</div>

</div>
  <div class="col-2 astro-QMDQII75"><ul class="links-list astro-SIOEHDSZ">
  <li class="astro-SIOEHDSZ">
        <a href="https://core.telegram.org/bots/api#getting-updates" class="links-list__link astro-SIOEHDSZ">
          Documentation about Telegram bots
        </a>
      </li>
</ul>

</div>
</div>

<div class="columns standard astro-QMDQII75">
  <div class="col-1 astro-QMDQII75"><p class="paragraph astro-IOL3HG2G">
  
        Now you can try how it works. Send your bot a message. Then open your
        terminal and enter these commands.
      
</p>



<!-- <style type="text/css">
  .article-layout {
    display: flex;
  }
  @media only screen and (max-width: 595px) {
    .article-layout {
      flex-direction: column;
    }
  }
  .article-layout__text {
    display: flex;
    margin-right: 42px;
  }
  .article-layout__quotes {
    display: flex;
    font-size: 15px;
  }
</style> --></div>
  <div class="col-2 astro-QMDQII75"></div>
</div>

<div class="columns standard astro-QMDQII75">
  <div class="col-1 astro-QMDQII75"><div class="code-snippet astro-L4T6MRF5">
  <div class="file-name"><img class="code-block__file-icon" src="/assets/console.4ea5677b.svg"/>Terminal</div>
  <pre class="astro-code" style="background-color: #ffffff; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;"><code><span class="line"><span style="color: #393a34"></span></span>
<span class="line"><span style="color: #393a34">        iex -S mix StocksBot.get_updates()</span></span>
<span class="line"><span style="color: #393a34">      </span></span></code></pre>

</div>

</div>
  <div class="col-2 astro-QMDQII75"></div>
</div>

<div class="columns standard astro-QMDQII75">
  <div class="col-1 astro-QMDQII75"><p class="paragraph astro-IOL3HG2G">
  In the terminal you will see incoming message:
</p>



<!-- <style type="text/css">
  .article-layout {
    display: flex;
  }
  @media only screen and (max-width: 595px) {
    .article-layout {
      flex-direction: column;
    }
  }
  .article-layout__text {
    display: flex;
    margin-right: 42px;
  }
  .article-layout__quotes {
    display: flex;
    font-size: 15px;
  }
</style> --></div>
  <div class="col-2 astro-QMDQII75"></div>
</div>

<div class="columns standard astro-QMDQII75">
  <div class="col-1 astro-QMDQII75"><div class="code-snippet astro-L4T6MRF5">
  
  <pre class="astro-code" style="background-color: #ffffff; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;"><code><span class="line"></span>
<span class="line"><span style="color: #999999">[</span></span>
<span class="line"><span style="color: #393A34">  %</span><span style="color: #999999">{</span></span>
<span class="line"><span style="color: #393A34">    </span><span style="color: #B56959AA">&quot;</span><span style="color: #B56959">message</span><span style="color: #B56959AA">&quot;</span><span style="color: #393A34"> </span><span style="color: #AB5959">=&gt;</span><span style="color: #393A34"> %</span><span style="color: #999999">{</span></span>
<span class="line"><span style="color: #393A34">      </span><span style="color: #B56959AA">&quot;</span><span style="color: #B56959">chat</span><span style="color: #B56959AA">&quot;</span><span style="color: #393A34"> </span><span style="color: #AB5959">=&gt;</span><span style="color: #393A34"> %</span><span style="color: #999999">{</span></span>
<span class="line"><span style="color: #393A34">        </span><span style="color: #B56959AA">&quot;</span><span style="color: #B56959">first_name</span><span style="color: #B56959AA">&quot;</span><span style="color: #393A34"> </span><span style="color: #AB5959">=&gt;</span><span style="color: #393A34"> </span><span style="color: #B56959AA">&quot;</span><span style="color: #B56959">Bender</span><span style="color: #B56959AA">&quot;</span><span style="color: #999999">,</span></span>
<span class="line"><span style="color: #393A34">        </span><span style="color: #B56959AA">&quot;</span><span style="color: #B56959">id</span><span style="color: #B56959AA">&quot;</span><span style="color: #393A34"> </span><span style="color: #AB5959">=&gt;</span><span style="color: #393A34"> </span><span style="color: #2F798A">300011235</span><span style="color: #999999">,</span></span>
<span class="line"><span style="color: #393A34">        </span><span style="color: #B56959AA">&quot;</span><span style="color: #B56959">last_name</span><span style="color: #B56959AA">&quot;</span><span style="color: #393A34"> </span><span style="color: #AB5959">=&gt;</span><span style="color: #393A34"> </span><span style="color: #B56959AA">&quot;</span><span style="color: #B56959">Rodriguez</span><span style="color: #B56959AA">&quot;</span><span style="color: #999999">,</span></span>
<span class="line"><span style="color: #393A34">        </span><span style="color: #B56959AA">&quot;</span><span style="color: #B56959">type</span><span style="color: #B56959AA">&quot;</span><span style="color: #393A34"> </span><span style="color: #AB5959">=&gt;</span><span style="color: #393A34"> </span><span style="color: #B56959AA">&quot;</span><span style="color: #B56959">private</span><span style="color: #B56959AA">&quot;</span><span style="color: #999999">,</span></span>
<span class="line"><span style="color: #393A34">        </span><span style="color: #B56959AA">&quot;</span><span style="color: #B56959">username</span><span style="color: #B56959AA">&quot;</span><span style="color: #393A34"> </span><span style="color: #AB5959">=&gt;</span><span style="color: #393A34"> </span><span style="color: #B56959AA">&quot;</span><span style="color: #B56959">bender</span><span style="color: #B56959AA">&quot;</span></span>
<span class="line"><span style="color: #393A34">      </span><span style="color: #999999">},</span></span>
<span class="line"><span style="color: #393A34">      </span><span style="color: #B56959AA">&quot;</span><span style="color: #B56959">date</span><span style="color: #B56959AA">&quot;</span><span style="color: #393A34"> </span><span style="color: #AB5959">=&gt;</span><span style="color: #393A34"> </span><span style="color: #2F798A">1636549063</span><span style="color: #999999">,</span></span>
<span class="line"><span style="color: #393A34">      </span><span style="color: #B56959AA">&quot;</span><span style="color: #B56959">from</span><span style="color: #B56959AA">&quot;</span><span style="color: #393A34"> </span><span style="color: #AB5959">=&gt;</span><span style="color: #393A34"> %</span><span style="color: #999999">{</span></span>
<span class="line"><span style="color: #393A34">        </span><span style="color: #B56959AA">&quot;</span><span style="color: #B56959">first_name</span><span style="color: #B56959AA">&quot;</span><span style="color: #393A34"> </span><span style="color: #AB5959">=&gt;</span><span style="color: #393A34"> </span><span style="color: #B56959AA">&quot;</span><span style="color: #B56959">Bender</span><span style="color: #B56959AA">&quot;</span><span style="color: #999999">,</span></span>
<span class="line"><span style="color: #393A34">        </span><span style="color: #B56959AA">&quot;</span><span style="color: #B56959">id</span><span style="color: #B56959AA">&quot;</span><span style="color: #393A34"> </span><span style="color: #AB5959">=&gt;</span><span style="color: #393A34"> </span><span style="color: #2F798A">300011235</span><span style="color: #999999">,,</span></span>
<span class="line"><span style="color: #393A34">        </span><span style="color: #B56959AA">&quot;</span><span style="color: #B56959">is_bot</span><span style="color: #B56959AA">&quot;</span><span style="color: #393A34"> </span><span style="color: #AB5959">=&gt;</span><span style="color: #393A34"> </span><span style="color: #1E754F">false</span><span style="color: #999999">,</span></span>
<span class="line"><span style="color: #393A34">        </span><span style="color: #B56959AA">&quot;</span><span style="color: #B56959">language_code</span><span style="color: #B56959AA">&quot;</span><span style="color: #393A34"> </span><span style="color: #AB5959">=&gt;</span><span style="color: #393A34"> </span><span style="color: #B56959AA">&quot;</span><span style="color: #B56959">ru</span><span style="color: #B56959AA">&quot;</span><span style="color: #999999">,</span></span>
<span class="line"><span style="color: #393A34">        </span><span style="color: #B56959AA">&quot;</span><span style="color: #B56959">last_name</span><span style="color: #B56959AA">&quot;</span><span style="color: #393A34"> </span><span style="color: #AB5959">=&gt;</span><span style="color: #393A34"> </span><span style="color: #B56959AA">&quot;</span><span style="color: #B56959">Rodriguez</span><span style="color: #B56959AA">&quot;</span><span style="color: #999999">,</span></span>
<span class="line"><span style="color: #393A34">        </span><span style="color: #B56959AA">&quot;</span><span style="color: #B56959">username</span><span style="color: #B56959AA">&quot;</span><span style="color: #393A34"> </span><span style="color: #AB5959">=&gt;</span><span style="color: #393A34"> </span><span style="color: #B56959AA">&quot;</span><span style="color: #B56959">bender</span><span style="color: #B56959AA">&quot;</span></span>
<span class="line"><span style="color: #393A34">      </span><span style="color: #999999">},</span></span>
<span class="line"><span style="color: #393A34">      </span><span style="color: #B56959AA">&quot;</span><span style="color: #B56959">message_id</span><span style="color: #B56959AA">&quot;</span><span style="color: #393A34"> </span><span style="color: #AB5959">=&gt;</span><span style="color: #393A34"> </span><span style="color: #2F798A">1142</span><span style="color: #999999">,</span></span>
<span class="line"><span style="color: #393A34">      </span><span style="color: #B56959AA">&quot;</span><span style="color: #B56959">text</span><span style="color: #B56959AA">&quot;</span><span style="color: #393A34"> </span><span style="color: #AB5959">=&gt;</span><span style="color: #393A34"> </span><span style="color: #B56959AA">&quot;</span><span style="color: #B56959">Hello</span><span style="color: #B56959AA">&quot;</span></span>
<span class="line"><span style="color: #393A34">    </span><span style="color: #999999">},</span></span>
<span class="line"><span style="color: #393A34">    </span><span style="color: #B56959AA">&quot;</span><span style="color: #B56959">update_id</span><span style="color: #B56959AA">&quot;</span><span style="color: #393A34"> </span><span style="color: #AB5959">=&gt;</span><span style="color: #393A34"> </span><span style="color: #2F798A">475896056</span></span>
<span class="line"><span style="color: #393A34">  </span><span style="color: #999999">}</span></span>
<span class="line"><span style="color: #999999">]</span></span>
<span class="line"><span style="color: #393A34">      </span></span></code></pre>

</div>

</div>
  <div class="col-2 astro-QMDQII75"></div>
</div>

<div class="columns standard astro-QMDQII75">
  <div class="col-1 astro-QMDQII75"><p class="paragraph astro-IOL3HG2G">
  
        If you try to receive messages again, the answer will be the same. This
        happens because it is necessary to indicate to the telegram which
        messages have already been received. To do this, take the <i class="astro-4LCKIGOU">update_id</i>

 of the last message, increase it to one and use it as a get parameter to
        receive new messages.
      
</p>



<!-- <style type="text/css">
  .article-layout {
    display: flex;
  }
  @media only screen and (max-width: 595px) {
    .article-layout {
      flex-direction: column;
    }
  }
  .article-layout__text {
    display: flex;
    margin-right: 42px;
  }
  .article-layout__quotes {
    display: flex;
    font-size: 15px;
  }
</style> --></div>
  <div class="col-2 astro-QMDQII75"></div>
</div>

<div class="columns standard astro-QMDQII75">
  <div class="col-1 astro-QMDQII75"><p class="paragraph astro-IOL3HG2G">
  So far, the script receives one message and stops working, but it needs
        to continue listening to new messages. I'll fix it now.
      
</p>



<!-- <style type="text/css">
  .article-layout {
    display: flex;
  }
  @media only screen and (max-width: 595px) {
    .article-layout {
      flex-direction: column;
    }
  }
  .article-layout__text {
    display: flex;
    margin-right: 42px;
  }
  .article-layout__quotes {
    display: flex;
    font-size: 15px;
  }
</style> --></div>
  <div class="col-2 astro-QMDQII75"></div>
</div>

<div class="columns standard astro-QMDQII75">
  <div class="col-1 astro-QMDQII75"><div class="code-snippet astro-L4T6MRF5">
  <div class="file-name"><img class="code-block__file-icon" src="/assets/file-2.ad06406a.svg"/>stocks_bot/lib/stocks_bot.ex</div>
  <pre class="astro-code" style="background-color: #ffffff; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;"><code><span class="line"></span>
<span class="line"><span style="color: #1E754F">defmodule</span><span style="color: #393A34"> </span><span style="color: #2E808F">StocksBot</span><span style="color: #393A34"> </span><span style="color: #1E754F">do</span></span>
<span class="line"><span style="color: #393A34">  </span><span style="color: #999999">@</span><span style="color: #B07D48">basic_url</span><span style="color: #393A34"> </span><span style="color: #B56959AA">&quot;</span><span style="color: #B56959">https://api.telegram.org/bot&lt;Токен от Botfather&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #B56959">  def get_updates(offset </span><span style="color: #A65E2B">\ </span><span style="color: #B56959">nil) do</span></span>
<span class="line"><span style="color: #B56959">    with {:ok, %HTTPoison.Response{status_code: 200, body: body}} =</span></span>
<span class="line"><span style="color: #B56959">           updates_url(offset) |&gt; HTTPoison.get(),</span></span>
<span class="line"><span style="color: #B56959">         {:ok, data} = Jason.decode(body) do</span></span>
<span class="line"></span>
<span class="line"><span style="color: #B56959">      parse_messages(data[</span><span style="color: #B56959AA">&quot;</span><span style="color: #393A34">result</span><span style="color: #B56959AA">&quot;</span><span style="color: #B56959">])</span></span>
<span class="line"><span style="color: #B56959">      |&gt; get_last_update_id()</span></span>
<span class="line"><span style="color: #B56959">      |&gt; get_updates()</span></span>
<span class="line"><span style="color: #B56959">    end</span></span>
<span class="line"><span style="color: #B56959">  end</span></span>
<span class="line"></span>
<span class="line"><span style="color: #B56959">  defp parse_messages(messages) do</span></span>
<span class="line"><span style="color: #B56959">    Enum.each(messages, fn message -&gt;</span></span>
<span class="line"><span style="color: #B56959">      IO.inspect(message)</span></span>
<span class="line"><span style="color: #B56959">    end)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #B56959">    messages</span></span>
<span class="line"><span style="color: #B56959">  end</span></span>
<span class="line"></span>
<span class="line"><span style="color: #B56959">  defp get_last_update_id(_messages = []) do</span></span>
<span class="line"><span style="color: #B56959">    nil</span></span>
<span class="line"><span style="color: #B56959">  end</span></span>
<span class="line"></span>
<span class="line"><span style="color: #B56959">  defp get_last_update_id(messages) do</span></span>
<span class="line"><span style="color: #B56959">    List.last(messages) |&gt; Map.fetch!(</span><span style="color: #B56959AA">&quot;</span><span style="color: #393A34">update_id</span><span style="color: #B56959AA">&quot;</span><span style="color: #B56959">)</span></span>
<span class="line"><span style="color: #B56959">  end</span></span>
<span class="line"></span>
<span class="line"><span style="color: #B56959">  defp updates_url(_offset = nil) do</span></span>
<span class="line"><span style="color: #B56959">    @basic_url &lt;&gt; </span><span style="color: #B56959AA">&quot;</span><span style="color: #393A34">getUpdates</span><span style="color: #B56959AA">&quot;</span></span>
<span class="line"><span style="color: #B56959">  end</span></span>
<span class="line"></span>
<span class="line"><span style="color: #B56959">  defp updates_url(offset) do</span></span>
<span class="line"><span style="color: #B56959">    @basic_url &lt;&gt; </span><span style="color: #B56959AA">&quot;</span><span style="color: #393A34">getUpdates?offset</span><span style="color: #999999">=</span><span style="color: #A0ADA0">#{offset + 1}&quot;</span></span>
<span class="line"><span style="color: #393A34">  </span><span style="color: #1E754F">end</span></span>
<span class="line"><span style="color: #1E754F">end</span></span>
<span class="line"><span style="color: #393A34">      </span></span></code></pre>

</div>

</div>
  <div class="col-2 astro-QMDQII75"></div>
</div>

<h3 class=" astro-3KQXSL4C">Polite answer</h3>

<div class="columns standard astro-QMDQII75">
  <div class="col-1 astro-QMDQII75"><div class="code-snippet astro-L4T6MRF5">
  <div class="file-name"><img class="code-block__file-icon" src="/assets/file-2.ad06406a.svg"/>stocks_bot/lib/stocks_bot.ex</div>
  <pre class="astro-code" style="background-color: #ffffff; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;"><code><span class="line"></span>
<span class="line"><span style="color: #AB5959">..</span><span style="color: #999999">.</span></span>
<span class="line"></span>
<span class="line"><span style="color: #1E754F">defp</span><span style="color: #393A34"> </span><span style="color: #59873A">parse_messages</span><span style="color: #999999">(</span><span style="color: #393A34">messages</span><span style="color: #999999">)</span><span style="color: #393A34"> </span><span style="color: #1E754F">do</span></span>
<span class="line"><span style="color: #393A34">  </span><span style="color: #2E808F">Enum</span><span style="color: #999999">.</span><span style="color: #59873A">each</span><span style="color: #999999">(</span><span style="color: #393A34">messages</span><span style="color: #999999">,</span><span style="color: #393A34"> </span><span style="color: #1E754F">fn</span><span style="color: #393A34"> message </span><span style="color: #AB5959">-&gt;</span></span>
<span class="line"><span style="color: #393A34">    </span><span style="color: #59873A">answer_to_message</span><span style="color: #999999">(</span><span style="color: #393A34">message</span><span style="color: #999999">)</span></span>
<span class="line"><span style="color: #393A34">  </span><span style="color: #1E754F">end</span><span style="color: #999999">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #393A34">  messages</span></span>
<span class="line"><span style="color: #1E754F">end</span></span>
<span class="line"></span>
<span class="line"><span style="color: #1E754F">defp</span><span style="color: #393A34"> </span><span style="color: #59873A">answer_to_message</span><span style="color: #999999">(</span><span style="color: #393A34">message</span><span style="color: #999999">)</span><span style="color: #393A34"> </span><span style="color: #1E754F">do</span></span>
<span class="line"><span style="color: #393A34">  %</span><span style="color: #999999">{</span></span>
<span class="line"><span style="color: #393A34">    </span><span style="color: #B56959AA">&quot;</span><span style="color: #B56959">message</span><span style="color: #B56959AA">&quot;</span><span style="color: #393A34"> </span><span style="color: #AB5959">=&gt;</span><span style="color: #393A34"> %</span><span style="color: #999999">{</span></span>
<span class="line"><span style="color: #393A34">      </span><span style="color: #B56959AA">&quot;</span><span style="color: #B56959">chat</span><span style="color: #B56959AA">&quot;</span><span style="color: #393A34"> </span><span style="color: #AB5959">=&gt;</span><span style="color: #393A34"> %</span><span style="color: #999999">{</span><span style="color: #B56959AA">&quot;</span><span style="color: #B56959">id</span><span style="color: #B56959AA">&quot;</span><span style="color: #393A34"> </span><span style="color: #AB5959">=&gt;</span><span style="color: #393A34"> chat_id</span><span style="color: #999999">},</span></span>
<span class="line"><span style="color: #393A34">      </span><span style="color: #B56959AA">&quot;</span><span style="color: #B56959">text</span><span style="color: #B56959AA">&quot;</span><span style="color: #393A34"> </span><span style="color: #AB5959">=&gt;</span><span style="color: #393A34"> original_text</span></span>
<span class="line"><span style="color: #393A34">    </span><span style="color: #999999">}</span></span>
<span class="line"><span style="color: #393A34">  </span><span style="color: #999999">}</span><span style="color: #393A34"> </span><span style="color: #999999">=</span><span style="color: #393A34"> message</span></span>
<span class="line"></span>
<span class="line"><span style="color: #393A34">  answer </span><span style="color: #999999">=</span><span style="color: #393A34"> %</span><span style="color: #999999">{</span></span>
<span class="line"><span style="color: #393A34">    </span><span style="color: #A65E2B">text</span><span style="color: #999999">:</span><span style="color: #393A34"> </span><span style="color: #B56959AA">&quot;</span><span style="color: #B56959">Hello: </span><span style="color: #999999">#{</span><span style="color: #393A34">original_text</span><span style="color: #999999">}</span><span style="color: #B56959AA">&quot;</span><span style="color: #999999">,</span></span>
<span class="line"><span style="color: #393A34">    </span><span style="color: #A65E2B">chat_id</span><span style="color: #999999">:</span><span style="color: #393A34"> chat_id</span></span>
<span class="line"><span style="color: #393A34">  </span><span style="color: #999999">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #393A34">  </span><span style="color: #2E808F">HTTPoison</span><span style="color: #999999">.</span><span style="color: #59873A">post</span><span style="color: #999999">(</span></span>
<span class="line"><span style="color: #393A34">    </span><span style="color: #999999">@</span><span style="color: #B07D48">basic_url</span><span style="color: #393A34"> </span><span style="color: #AB5959">&lt;&gt;</span><span style="color: #393A34"> </span><span style="color: #B56959AA">&quot;</span><span style="color: #B56959">sendMessage</span><span style="color: #B56959AA">&quot;</span><span style="color: #999999">,</span></span>
<span class="line"><span style="color: #393A34">    </span><span style="color: #2E808F">Jason</span><span style="color: #999999">.</span><span style="color: #59873A">encode!</span><span style="color: #999999">(</span><span style="color: #393A34">answer</span><span style="color: #999999">),</span></span>
<span class="line"><span style="color: #393A34">    </span><span style="color: #999999">[{</span><span style="color: #B56959AA">&quot;</span><span style="color: #B56959">Content-Type</span><span style="color: #B56959AA">&quot;</span><span style="color: #999999">,</span><span style="color: #393A34"> </span><span style="color: #B56959AA">&quot;</span><span style="color: #B56959">application/json</span><span style="color: #B56959AA">&quot;</span><span style="color: #999999">}]</span></span>
<span class="line"><span style="color: #393A34">  </span><span style="color: #999999">)</span></span>
<span class="line"><span style="color: #1E754F">end</span></span>
<span class="line"><span style="color: #393A34">        </span></span></code></pre>

</div>

</div>
  <div class="col-2 astro-QMDQII75"></div>
</div>

<div class="columns standard astro-QMDQII75">
  <div class="col-1 astro-QMDQII75"><p class="paragraph astro-IOL3HG2G">
  The <i class="astro-4LCKIGOU">answer_to_message</i>

 function uses pattern matching
        to pick up the sender's name and the text of the incoming message to send
        it back to the user as a post-request.
      
</p>



<!-- <style type="text/css">
  .article-layout {
    display: flex;
  }
  @media only screen and (max-width: 595px) {
    .article-layout {
      flex-direction: column;
    }
  }
  .article-layout__text {
    display: flex;
    margin-right: 42px;
  }
  .article-layout__quotes {
    display: flex;
    font-size: 15px;
  }
</style> --></div>
  <div class="col-2 astro-QMDQII75"></div>
</div>

<h3 class=" astro-3KQXSL4C">Using supervisor for the application</h3>

<div class="columns standard astro-QMDQII75">
  <div class="col-1 astro-QMDQII75"><p class="paragraph astro-IOL3HG2G">
  First step is converting app to a Genserver.
</p>



<!-- <style type="text/css">
  .article-layout {
    display: flex;
  }
  @media only screen and (max-width: 595px) {
    .article-layout {
      flex-direction: column;
    }
  }
  .article-layout__text {
    display: flex;
    margin-right: 42px;
  }
  .article-layout__quotes {
    display: flex;
    font-size: 15px;
  }
</style> --></div>
  <div class="col-2 astro-QMDQII75"></div>
</div>

<div class="columns standard astro-QMDQII75">
  <div class="col-1 astro-QMDQII75"><div class="code-snippet astro-L4T6MRF5">
  <div class="file-name"><img class="code-block__file-icon" src="/assets/file-2.ad06406a.svg"/>stocks_bot/lib/stocks_bot.ex</div>
  <pre class="astro-code" style="background-color: #ffffff; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;"><code><span class="line"></span>
<span class="line"><span style="color: #1E754F">defmodule</span><span style="color: #393A34"> </span><span style="color: #2E808F">StocksBot</span><span style="color: #393A34"> </span><span style="color: #1E754F">do</span></span>
<span class="line"><span style="color: #393A34">  </span><span style="color: #1E754F">use</span><span style="color: #393A34"> </span><span style="color: #2E808F">GenServer</span></span>
<span class="line"><span style="color: #393A34">  </span><span style="color: #999999">@</span><span style="color: #B07D48">basic_url</span><span style="color: #393A34"> </span><span style="color: #B56959AA">&quot;</span><span style="color: #B56959">https://api.telegram.org/bot&lt;Токен от Botfather&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #B56959">  def start_link(args) do</span></span>
<span class="line"><span style="color: #B56959">    GenServer.start_link(__MODULE__, :ok, name: __MODULE__)</span></span>
<span class="line"><span style="color: #B56959">  end</span></span>
<span class="line"></span>
<span class="line"><span style="color: #B56959">  @impl true</span></span>
<span class="line"><span style="color: #B56959">  def init(:ok) do</span></span>
<span class="line"><span style="color: #B56959">    get_updates()</span></span>
<span class="line"><span style="color: #B56959">    {:ok, %{}}</span></span>
<span class="line"><span style="color: #B56959">  end</span></span>
<span class="line"></span>
<span class="line"><span style="color: #B56959">...</span></span>
<span class="line"><span style="color: #B56959">        </span></span></code></pre>

</div>

</div>
  <div class="col-2 astro-QMDQII75"></div>
</div>

<div class="columns standard astro-QMDQII75">
  <div class="col-1 astro-QMDQII75"><p class="paragraph astro-IOL3HG2G">
  Then this Genserver need to be added to Supervisor Tree.
</p>



<!-- <style type="text/css">
  .article-layout {
    display: flex;
  }
  @media only screen and (max-width: 595px) {
    .article-layout {
      flex-direction: column;
    }
  }
  .article-layout__text {
    display: flex;
    margin-right: 42px;
  }
  .article-layout__quotes {
    display: flex;
    font-size: 15px;
  }
</style> --></div>
  <div class="col-2 astro-QMDQII75"></div>
</div>

<div class="columns standard astro-QMDQII75">
  <div class="col-1 astro-QMDQII75"><div class="code-snippet astro-L4T6MRF5">
  <div class="file-name"><img class="code-block__file-icon" src="/assets/file-2.ad06406a.svg"/>stocks_bot/lib/stocks_bot/application.ex</div>
  <pre class="astro-code" style="background-color: #ffffff; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;"><code><span class="line"></span>
<span class="line"><span style="color: #1E754F">defmodule</span><span style="color: #393A34"> </span><span style="color: #59873A">StocksBot</span><span style="color: #393A34">.</span><span style="color: #2E808F">Application</span><span style="color: #393A34"> </span><span style="color: #1E754F">do</span></span>
<span class="line"><span style="color: #393A34">  </span><span style="color: #1E754F">use</span><span style="color: #393A34"> </span><span style="color: #2E808F">Application</span></span>
<span class="line"></span>
<span class="line"><span style="color: #393A34">  </span><span style="color: #999999">@</span><span style="color: #B07D48">impl</span><span style="color: #393A34"> </span><span style="color: #1E754F">true</span></span>
<span class="line"><span style="color: #393A34">  </span><span style="color: #1E754F">def</span><span style="color: #393A34"> </span><span style="color: #59873A">start</span><span style="color: #999999">(</span><span style="color: #A0ADA0">_type</span><span style="color: #999999">,</span><span style="color: #393A34"> </span><span style="color: #A0ADA0">_args</span><span style="color: #999999">)</span><span style="color: #393A34"> </span><span style="color: #1E754F">do</span></span>
<span class="line"><span style="color: #393A34">    children </span><span style="color: #999999">=</span><span style="color: #393A34"> </span><span style="color: #999999">[</span><span style="color: #393A34"> </span><span style="color: #2E808F">StocksBot</span><span style="color: #393A34"> </span><span style="color: #999999">]</span></span>
<span class="line"></span>
<span class="line"><span style="color: #393A34">    opts </span><span style="color: #999999">=</span><span style="color: #393A34"> </span><span style="color: #999999">[</span><span style="color: #A65E2B">strategy</span><span style="color: #999999">:</span><span style="color: #393A34"> </span><span style="color: #999999">:</span><span style="color: #A65E2B">one_for_one</span><span style="color: #999999">,</span><span style="color: #393A34"> </span><span style="color: #A65E2B">name</span><span style="color: #999999">:</span><span style="color: #393A34"> </span><span style="color: #2E808F">StocksBot</span><span style="color: #999999">.</span><span style="color: #2E808F">Supervisor</span><span style="color: #999999">]</span></span>
<span class="line"><span style="color: #393A34">    </span><span style="color: #2E808F">Supervisor</span><span style="color: #999999">.</span><span style="color: #59873A">start_link</span><span style="color: #999999">(</span><span style="color: #393A34">children</span><span style="color: #999999">,</span><span style="color: #393A34"> opts</span><span style="color: #999999">)</span></span>
<span class="line"><span style="color: #393A34">  </span><span style="color: #1E754F">end</span></span>
<span class="line"><span style="color: #1E754F">end</span></span>
<span class="line"><span style="color: #393A34">        </span></span></code></pre>

</div>

</div>
  <div class="col-2 astro-QMDQII75"><ul class="links-list astro-SIOEHDSZ">
  <li class="astro-SIOEHDSZ">
        <a href="https://blog.appsignal.com/2021/08/23/using-supervisors-to-organize-your-elixir-application.html" class="links-list__link astro-SIOEHDSZ">
          Article from AppSignal with good examples
        </a>
      </li>
</ul>

</div>
</div>

<h2 class=" astro-3KQXSL4C">Demo time</h2>

<div class="columns standard astro-QMDQII75">
  <div class="col-1 astro-QMDQII75"><video controls loop class="post__video astro-7FVP5DK2">
  <source src="/videos/posts/elixir-telegram-bot/demo_of_bot.mp4" type="video/mp4" class="astro-7FVP5DK2">
</video>

</div>
  <div class="col-2 astro-QMDQII75"></div>
</div>

<div class="columns standard astro-QMDQII75">
  <div class="col-1 astro-QMDQII75"><p class="paragraph astro-IOL3HG2G">
  Yes, the bot does not yet have superintelligence. In the next part, I
        will add user storage in the database and teach the bot to send stock
        price information.
</p>



<!-- <style type="text/css">
  .article-layout {
    display: flex;
  }
  @media only screen and (max-width: 595px) {
    .article-layout {
      flex-direction: column;
    }
  }
  .article-layout__text {
    display: flex;
    margin-right: 42px;
  }
  .article-layout__quotes {
    display: flex;
    font-size: 15px;
  }
</style> --></div>
  <div class="col-2 astro-QMDQII75"></div>
</div>


</div>


    </div>
    
  </body>
</html>