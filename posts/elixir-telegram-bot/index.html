<!doctype html>
<html data-n-head-ssr lang="en" data-n-head="%7B%22lang%22:%7B%22ssr%22:%22en%22%7D%7D">
  <head>
    <title>How to make a Telegram bot in Elixir</title><meta data-n-head="ssr" charset="utf-8"><meta data-n-head="ssr" name="viewport" content="width=device-width"><meta data-n-head="ssr" data-hid="description" name="description" content=""><meta data-n-head="ssr" name="format-detection" content="telephone=no"><meta data-n-head="ssr" data-hid="twitter:card" name="twitter:card" content="summary_large_image"><meta data-n-head="ssr" data-hid="twitter:title" name="twitter:title" content="How to make a Telegram bot in Elixir"><meta data-n-head="ssr" data-hid="twitter:description" name="twitter:description" content="This is the first part of three in the series. There you will find creating foundation and answering to users."><meta data-n-head="ssr" data-hid="og:title" property="og:title" content="How to make a Telegram bot in Elixir"><meta data-n-head="ssr" data-hid="og:description" property="og:description" content="This is the first part of three in the series. There you will find creating foundation and answering to users."><meta data-n-head="ssr" data-hid="og:image" property="og:image" content="https://rukomoynikov.ru/_nuxt/img/facebook-share.ebe593e.jpg"><meta data-n-head="ssr" data-hid="og:image:secure_url" property="og:image:secure_url" content="https://rukomoynikov.ru/_nuxt/img/facebook-share.ebe593e.jpg"><meta data-n-head="ssr" data-hid="og:image:alt" property="og:image:alt" content="How to make a Telegram bot in Elixir"><link data-n-head="ssr" rel="icon" type="image/x-icon" href="/favicon/favicon.ico"><link data-n-head="ssr" rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png"><link data-n-head="ssr" rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png"><link data-n-head="ssr" rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png"><link data-n-head="ssr" rel="manifest" href="/favicon/site.webmanifest"><link data-n-head="ssr" rel="mask-icon" href="/favicon/safari-pinned-tab.svg" color="#5bbad5"><script data-n-head="ssr" src="https://plausible.io/js/plausible.js" defer data-domain="rukomoynikov.ru"></script><link rel="preload" href="/_nuxt/d28dcec.js" as="script"><link rel="preload" href="/_nuxt/8cc0c0c.js" as="script"><link rel="preload" href="/_nuxt/0647000.js" as="script"><link rel="preload" href="/_nuxt/6428579.js" as="script"><link rel="preload" href="/_nuxt/031ce0a.js" as="script"><style data-vue-ssr-id="42838bd4:0 ab8fb0f8:0 43dee4e4:0 fa7ff0ca:0 52f5f283:0 59ee5bee:0 f17c3d94:0 5edaacb0:0 10f5b334:0 07a0ed3c:0 76c4480e:0 0c132c00:0 f3cd4790:0 106855a6:0 1a5c2406:0 700a9420:0">@font-face{font-family:'IBM Plex Sans';src:url(/_nuxt/fonts/IBMPlexSans-ExtraLightItalic.19fadbb.woff2) format('woff2'),url(/_nuxt/fonts/IBMPlexSans-ExtraLightItalic.0b4a9f0.woff) format('woff');font-weight:200;font-style:italic;font-display:swap}@font-face{font-family:'IBM Plex Sans';src:url(/_nuxt/fonts/IBMPlexSans-BoldItalic.8382e18.woff2) format('woff2'),url(/_nuxt/fonts/IBMPlexSans-BoldItalic.e9dbc59.woff) format('woff');font-weight:700;font-style:italic;font-display:swap}@font-face{font-family:'IBM Plex Sans';src:url(/_nuxt/fonts/IBMPlexSans-Italic.9419ba2.woff2) format('woff2'),url(/_nuxt/fonts/IBMPlexSans-Italic.23eee9c.woff) format('woff');font-weight:400;font-style:italic;font-display:swap}@font-face{font-family:'IBM Plex Sans';src:url(/_nuxt/fonts/IBMPlexSans-Bold.92e83f7.woff2) format('woff2'),url(/_nuxt/fonts/IBMPlexSans-Bold.be75364.woff) format('woff');font-weight:700;font-style:normal;font-display:swap}@font-face{font-family:'IBM Plex Sans';src:url(/_nuxt/fonts/IBMPlexSans-ExtraLight.b494911.woff2) format('woff2'),url(/_nuxt/fonts/IBMPlexSans-ExtraLight.c7f9c6f.woff) format('woff');font-weight:200;font-style:normal;font-display:swap}@font-face{font-family:'IBM Plex Sans';src:url(/_nuxt/fonts/IBMPlexSans-SemiBold.4d4db3a.woff2) format('woff2'),url(/_nuxt/fonts/IBMPlexSans-SemiBold.54dbdeb.woff) format('woff');font-weight:600;font-style:normal;font-display:swap}@font-face{font-family:'IBM Plex Sans';src:url(/_nuxt/fonts/IBMPlexSans-Medium.c438300.woff2) format('woff2'),url(/_nuxt/fonts/IBMPlexSans-Medium.c8cb78a.woff) format('woff');font-weight:500;font-style:normal;font-display:swap}@font-face{font-family:'IBM Plex Sans';src:url(/_nuxt/fonts/IBMPlexSans-LightItalic.cb534a4.woff2) format('woff2'),url(/_nuxt/fonts/IBMPlexSans-LightItalic.2fdf067.woff) format('woff');font-weight:300;font-style:italic;font-display:swap}@font-face{font-family:'IBM Plex Sans';src:url(/_nuxt/fonts/IBMPlexSans-MediumItalic.a4a6f59.woff2) format('woff2'),url(/_nuxt/fonts/IBMPlexSans-MediumItalic.3e90435.woff) format('woff');font-weight:500;font-style:italic;font-display:swap}@font-face{font-family:'IBM Plex Sans';src:url(/_nuxt/fonts/IBMPlexSans-ThinItalic.236c1c6.woff2) format('woff2'),url(/_nuxt/fonts/IBMPlexSans-ThinItalic.550931c.woff) format('woff');font-weight:100;font-style:italic;font-display:swap}@font-face{font-family:'IBM Plex Sans';src:url(/_nuxt/fonts/IBMPlexSans-Light.94824c3.woff2) format('woff2'),url(/_nuxt/fonts/IBMPlexSans-Light.6deeae9.woff) format('woff');font-weight:300;font-style:normal;font-display:swap}@font-face{font-family:'IBM Plex Sans';src:url(/_nuxt/fonts/IBMPlexSans-Thin.48a004c.woff2) format('woff2'),url(/_nuxt/fonts/IBMPlexSans-Thin.a0bf478.woff) format('woff');font-weight:100;font-style:normal;font-display:swap}@font-face{font-family:'IBM Plex Sans';src:url(/_nuxt/fonts/IBMPlexSans-SemiBoldItalic.1ea1b42.woff2) format('woff2'),url(/_nuxt/fonts/IBMPlexSans-SemiBoldItalic.51a17ed.woff) format('woff');font-weight:600;font-style:italic;font-display:swap}@font-face{font-family:'IBM Plex Sans';src:url(/_nuxt/fonts/IBMPlexSans-Regular.8a1d71e.woff2) format('woff2'),url(/_nuxt/fonts/IBMPlexSans-Regular.f578949.woff) format('woff');font-weight:400;font-style:normal;font-display:swap}@font-face{font-family:'IBM Plex Mono';src:url(/_nuxt/fonts/IBMPlexMono-BoldItalic.dfc303c.woff2) format('woff2'),url(/_nuxt/fonts/IBMPlexMono-BoldItalic.4e61f02.woff) format('woff');font-weight:700;font-style:italic;font-display:swap}@font-face{font-family:'IBM Plex Mono';src:url(/_nuxt/fonts/IBMPlexMono-Medium.147a566.woff2) format('woff2'),url(/_nuxt/fonts/IBMPlexMono-Medium.7ff5157.woff) format('woff');font-weight:500;font-style:normal;font-display:swap}@font-face{font-family:'IBM Plex Mono';src:url(/_nuxt/fonts/IBMPlexMono-Light.5a1f45e.woff2) format('woff2'),url(/_nuxt/fonts/IBMPlexMono-Light.18d1c63.woff) format('woff');font-weight:300;font-style:normal;font-display:swap}@font-face{font-family:'IBM Plex Mono';src:url(/_nuxt/fonts/IBMPlexMono-MediumItalic.fc6c5cb.woff2) format('woff2'),url(/_nuxt/fonts/IBMPlexMono-MediumItalic.d438c7d.woff) format('woff');font-weight:500;font-style:italic;font-display:swap}@font-face{font-family:'IBM Plex Mono';src:url(/_nuxt/fonts/IBMPlexMono-Italic.cd0ddb1.woff2) format('woff2'),url(/_nuxt/fonts/IBMPlexMono-Italic.ba043e3.woff) format('woff');font-weight:400;font-style:italic;font-display:swap}@font-face{font-family:'IBM Plex Mono';src:url(/_nuxt/fonts/IBMPlexMono-Bold.1d05f1f.woff2) format('woff2'),url(/_nuxt/fonts/IBMPlexMono-Bold.b42d57c.woff) format('woff');font-weight:700;font-style:normal;font-display:swap}@font-face{font-family:'IBM Plex Mono';src:url(/_nuxt/fonts/IBMPlexMono-ExtraLightItalic.d6ddd0e.woff2) format('woff2'),url(/_nuxt/fonts/IBMPlexMono-ExtraLightItalic.42c307f.woff) format('woff');font-weight:200;font-style:italic;font-display:swap}@font-face{font-family:'IBM Plex Mono';src:url(/_nuxt/fonts/IBMPlexMono-LightItalic.2552638.woff2) format('woff2'),url(/_nuxt/fonts/IBMPlexMono-LightItalic.94f0e32.woff) format('woff');font-weight:300;font-style:italic;font-display:swap}@font-face{font-family:'IBM Plex Mono';src:url(/_nuxt/fonts/IBMPlexMono-ExtraLight.b1e481e.woff2) format('woff2'),url(/_nuxt/fonts/IBMPlexMono-ExtraLight.0e72c65.woff) format('woff');font-weight:200;font-style:normal;font-display:swap}@font-face{font-family:'IBM Plex Mono';src:url(/_nuxt/fonts/IBMPlexMono-SemiBoldItalic.8a67a3f.woff2) format('woff2'),url(/_nuxt/fonts/IBMPlexMono-SemiBoldItalic.7d351c4.woff) format('woff');font-weight:600;font-style:italic;font-display:swap}@font-face{font-family:'IBM Plex Mono';src:url(/_nuxt/fonts/IBMPlexMono-Thin.b866527.woff2) format('woff2'),url(/_nuxt/fonts/IBMPlexMono-Thin.bebab09.woff) format('woff');font-weight:100;font-style:normal;font-display:swap}@font-face{font-family:'IBM Plex Mono';src:url(/_nuxt/fonts/IBMPlexMono-SemiBold.38bc1dc.woff2) format('woff2'),url(/_nuxt/fonts/IBMPlexMono-SemiBold.050dbf6.woff) format('woff');font-weight:600;font-style:normal;font-display:swap}@font-face{font-family:'IBM Plex Mono';src:url(/_nuxt/fonts/IBMPlexMono-Regular.56d2027.woff2) format('woff2'),url(/_nuxt/fonts/IBMPlexMono-Regular.6db7b67.woff) format('woff');font-weight:400;font-style:normal;font-display:swap}@font-face{font-family:'IBM Plex Mono';src:url(/_nuxt/fonts/IBMPlexMono-ThinItalic.77a6c5b.woff2) format('woff2'),url(/_nuxt/fonts/IBMPlexMono-ThinItalic.10ed423.woff) format('woff');font-weight:100;font-style:italic;font-display:swap}body{font-family:"IBM Plex Sans",sans-serif;font-display:block;background-color:#fbf5ee;margin:0;padding:0}*{box-sizing:border-box}.nuxt-progress{position:fixed;top:0;left:0;right:0;height:2px;width:0%;opacity:1;transition:width .1s,opacity .4s;background-color:#000;z-index:999999}.nuxt-progress.nuxt-progress-notransition{transition:none}.nuxt-progress-failed{background-color:red}.content[data-v-c385937c]{min-height:calc(100vh - 218px)}.header[data-v-3ead3413]{display:flex;max-width:1200px;width:100%;margin:20px auto 20px auto;padding:0 10px}.logo[data-v-3ead3413]{font:400 50px/54px IBM Plex Sans,sans-serif;margin-right:auto;color:#000;text-decoration:none}@media only screen and (max-width:595px){.logo[data-v-3ead3413]{font:400 40px/42px IBM Plex Sans,sans-serif}}.slogan[data-v-3ead3413]{font:300 20px/27px IBM Plex Sans,sans-serif;max-width:271px;margin-top:7px;margin-right:20px}@media only screen and (max-width:595px){.slogan[data-v-3ead3413]{display:none}}.links[data-v-3ead3413]{margin-top:9px}.link[data-v-3ead3413]{font:300 20px/27px IBM Plex Sans,sans-serif;color:#3a4a6a;display:block;margin-bottom:3px}@media only screen and (max-width:595px){.link[data-v-3ead3413]{font:300 17px/21px IBM Plex Sans,sans-serif}}.post__video[data-v-7313dbe1]{width:100%;margin-bottom:18px}.post__sub-section[data-v-7313dbe1]{margin-bottom:30px}.i-span[data-v-7313dbe1]{padding:1px 4px;border-radius:20px;background:rgba(69,156,193,.24);color:#fff}.hero-title[data-v-9a6ba7c8]{background-color:#ebec96;opacity:.8;background-size:40px 40px}.hero-title__tag[data-v-9a6ba7c8]{padding:12px 17px;font:600 17px IBM Plex Sans,sans-serif;background-color:#fff;display:inline-flex;border-radius:12px}.hero-title__tag[data-v-9a6ba7c8]:not(:last-of-type){margin-right:24px}.hero-title__title[data-v-9a6ba7c8]{font:normal 62px/68px IBM Plex Sans,sans-serif;margin:18px 0 0 0;max-width:1000px;color:#000}@media only screen and (max-width:595px){.hero-title__title[data-v-9a6ba7c8]{font:normal 54px/58px IBM Plex Sans,sans-serif;margin:18px 0 0 0}}.hero-title__container[data-v-9a6ba7c8]{max-width:1200px;width:100%;margin:auto}.hero-title__subtitle[data-v-9a6ba7c8]{margin-top:22px;font:300 28px/33px IBM Plex Sans,sans-serif;max-width:800px;color:#000}.hero-title__image[data-v-9a6ba7c8]{margin-top:59px;border:10px solid #fff;overflow:hidden;max-width:100%}.hero-title__text-container[data-v-9a6ba7c8]{padding:35px 10px 60px 10px}.container_common{max-width:1200px;width:100%;margin:0 auto 20px auto;padding:50px 10px 0 10px}.container_content{max-width:800px}.title_h2{margin:0 0 20px 0;padding:0;color:#c91010;font:normal 28px IBM Plex Sans,sans-serif}.title_h3{font-size:19px;font-weight:700;margin:0 0 8px 0;letter-spacing:calc(1px / 5)}.paragraph{font-size:19px}.paragraph:first-of-type{margin-top:0}.links-list{list-style-type:none;margin:0;padding:0}.links-list__link{color:#b66e6e;display:flex}.links-list>li{margin-bottom:10px;font-size:16px}.links-list__link::before{content:' ';background-image:url(/_nuxt/img/link-2.ca17a71.svg);background-repeat:no-repeat;margin-right:4px;margin-top:2px;display:block;width:1em;height:1em}.spacing_vertical-section{height:22px}.spacing_vertical-section_sub{margin-bottom:30px}.code-block{background:#fff;padding:10px 12px;overflow-x:scroll;margin:0 0 18px 0;color:#151577}.code-block_short{padding:6px 12px}.code-block__filename{background:#dbf0ff;padding:6px 12px;display:flex;align-items:center;font-weight:400}.code-block__file-icon{height:1em;margin-right:5px}.italic{border:1px dashed #000;border-radius:11px;padding:0 5px}.container{max-width:1200px;width:100%;margin:0 auto 20px auto;padding:0 10px}</style><link rel="preload" href="/_nuxt/static/1644954099/posts/elixir-telegram-bot/state.js" as="script"><link rel="preload" href="/_nuxt/static/1644954099/posts/elixir-telegram-bot/payload.js" as="script"><link rel="preload" href="/_nuxt/static/1644954099/manifest.js" as="script">
  </head>
  <body>
    <div data-server-rendered="true" id="__nuxt"><!----><div id="__layout"><div data-v-c385937c><div class="header" data-v-3ead3413 data-v-c385937c><a href="/" class="logo nuxt-link-active" data-v-3ead3413>
    Maxim<br data-v-3ead3413>Rukomoynikov
  </a> <div class="slogan" data-v-3ead3413>
    I love to create. Developer and designer. Looking forward to make cool things.
  </div> <div class="links" data-v-3ead3413><a href="https://twitter.com/Rukomoynikov" class="link" data-v-3ead3413>twitter</a> <a href="https://www.facebook.com/rukomoynikov" class="link" data-v-3ead3413>facebook</a> <a href="https://www.behance.net/ruq" class="link" data-v-3ead3413>behance</a></div></div> <div class="content" data-v-c385937c><div data-v-7313dbe1 data-v-c385937c><!----> <div class="hero-title" data-v-9a6ba7c8 data-v-7313dbe1><div class="hero-title__container" data-v-9a6ba7c8><div class="hero-title__text-container" data-v-9a6ba7c8><div class="hero-title__tag" data-v-9a6ba7c8>
        Telegram
      </div><div class="hero-title__tag" data-v-9a6ba7c8>
        Elixir
      </div> <h2 class="hero-title__title" data-v-9a6ba7c8>
        How to make a Telegram bot in Elixir
      </h2> <!----></div></div></div> <div class="container_common" data-v-7313dbe1><section data-v-7313dbe1><h2 class="title_h2" data-v-7313dbe1>
        Introduction to Telegram Bots API
      </h2> <section data-v-7313dbe1><h3 class="title_h3" data-v-7313dbe1>
          Exchanging messages with Telegram
        </h3> <div class="container_content" data-v-7313dbe1><p class="paragraph" data-v-7313dbe1>
            Telegram supports two types of integration: webhooks and polling. Webhooks it's a type when Telegram sends request to your server whenever bot recevied a message from the user. There pros and cons of that type of integration. Webhooks are more sustainable in general. For webhooks it's necessary to have web-server with external IP adress. This server will receive new messages through get requests from Telegram. During development you can use ngrock.
          </p> <p class="paragraph" data-v-7313dbe1>
            Polling is a constant polling of the Telegram server for new messages. For polling, you do not need a server and an external address. Simple application that sends requests to the Telegram server without stopping is enough.
          </p> <ul class="links-list" data-v-7313dbe1><li><a href="https://core.telegram.org/bots/api#getting-updates" class="links-list__link">
      Documentation about Telegram bots
    </a></li></ul></div></section> <div class="spacing_vertical-section_sub" data-v-7313dbe1></div> <section data-v-7313dbe1><h3 class="title_h3" data-v-7313dbe1>
          Obtaining a token from Telegram
        </h3> <div class="container_content" data-v-7313dbe1><p class="paragraph" data-v-7313dbe1>
            The token for Telegram requests must be obtained from the BotFather bot.
          </p> <video controls loop class="post__video" data-v-7313dbe1><source src="/_nuxt/videos/api_token.7f56044.mp4" type="video/mp4" data-v-7313dbe1></video> <ul class="links-list" data-v-7313dbe1><li><a href="https://t.me/botfather" class="links-list__link">
      Botfather
    </a></li></ul></div></section> <div class="spacing_vertical-section_sub" data-v-7313dbe1></div></section> <div class="spacing_vertical-section" data-v-7313dbe1></div> <section data-v-7313dbe1><h2 class="title_h2" data-v-7313dbe1>
        Elixir
      </h2> <section data-v-7313dbe1><div class="container_content" data-v-7313dbe1><p class="paragraph" data-v-7313dbe1>
            Elixir is a functional programming language. Based on the another programming language Erlang. The main advantage of Elixir is the ability to manage a huge number of processes. These processes are also made in a special way, so they take up significantly less memory and processor time than normal computer processes.
          </p> <ul class="links-list" data-v-7313dbe1><li><a href="https://elixir-lang.org/install.html" class="links-list__link">
      How to install Elixir one elixir-lang.org
    </a></li><li><a href="https://gist.github.com/mikoscz/4d2a0052d4cdaaa027bc8a8d6af1e817" class="links-list__link">
      Installing with asdf package manager
    </a></li></ul></div></section> <div class="spacing_vertical-section_sub" data-v-7313dbe1></div></section> <div class="spacing_vertical-section" data-v-7313dbe1></div> <section data-v-7313dbe1><h2 class="title_h2" data-v-7313dbe1>
        The application
      </h2> <div class="container_content" data-v-7313dbe1><p class="paragraph" data-v-7313dbe1>
          I will gradually complicate the application. I'll start with a echo bot that sends a message back in response to a message. Next, I will add saving users to the database. And in the end, I'll try to make it a little useful - upon request from the user, the bot will send summary information about the stock market.
        </p> <section data-v-7313dbe1><h3 class="title_h3" data-v-7313dbe1>
            Creation of the skeleton of the application and installation of the necessary tools
          </h3> <div class="content-container" data-v-7313dbe1><div data-v-7313dbe1><!----> <pre class="code-block code-block_short"><div data-v-7313dbe1>mix new stocks_bot --sup</div></pre></div> <p class="paragraph" data-v-7313dbe1>
              First you need to create a new application. The <i class="italic" data-v-7313dbe1>--sup</i> option adds a supervisor to the application and starts it at startup. After creation, the structure of the application should look like this:
            </p> <div data-v-7313dbe1><!----> <pre class="code-block"><div data-v-7313dbe1>stocks_bot
├── README.md
├── lib
│   ├── stocks_bot
│   │   └── application.ex
│   └── stocks_bot.ex
├── mix.exs
└── test
├── stocks_bot_test.exs
└── test_helper.exs
</div></pre></div> <p class="paragraph" data-v-7313dbe1>
              Additionally, you need to install HTTPoison to send requests and Jason to work with Jason in responses from the Telegram server.
            </p> <div data-v-7313dbe1><div class="code-block__filename"><img src="/_nuxt/img/file-2.a78a4f7.svg" class="code-block__file-icon">
    stocks_bot/mix.exs
  </div> <pre class="code-block"><div data-v-7313dbe1>...

defp deps do
  [
    {:httpoison, "~> 1.8"},
    {:jason, "~> 1.2"}
  ]
end
  </div></pre></div></div> <ul class="links-list" data-v-7313dbe1><li><a href="https://hex.pm/packages/httpoison" class="links-list__link">
      HTTPoisin — http-client for Elixir
    </a></li><li><a href="https://hex.pm/packages/jason" class="links-list__link">
      Jason — library for working with JSON
    </a></li></ul></section></div> <div class="spacing_vertical-section_sub" data-v-7313dbe1></div> <section data-v-7313dbe1><h3 class="title_h3" data-v-7313dbe1>
          Receiving user message
        </h3> <div class="container_content" data-v-7313dbe1><div data-v-7313dbe1><div class="code-block__filename"><img src="/_nuxt/img/file-2.a78a4f7.svg" class="code-block__file-icon">
    stocks_bot/lib/stocks_bot.ex
  </div> <pre class="code-block"><div data-v-7313dbe1>defmodule StocksBot do
  @basic_url "https://api.telegram.org/bot&lt;Токен от Botfather>

  def get_updates(offset \\ nil) do
    with {:ok, %HTTPoison.Response{status_code: 200, body: body}} =
           updates_url(offset) |> HTTPoison.get(),
         {:ok, data} = Jason.decode(body) do
      IO.inspect(data["result"])
    end
  end

  defp updates_url(_offset = nil) do
    @basic_url &lt;> "getUpdates"
  end
end
</div></pre></div> <p class="paragraph" data-v-7313dbe1>
            Now you can try how it works. Send your bot a message. Then open your terminal and enter these commands.
          </p> <div data-v-7313dbe1><div class="code-block__filename"><img src="data:image/svg+xml;base64,PHN2ZyB2aWV3Qm94PSIwIDAgOTAgNzAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CiAgPHBhdGggZD0iTTg1IDBINWE1LjAwNiA1LjAwNiAwIDAgMC01IDV2NjVoOTBWNWE1LjAwNiA1LjAwNiAwIDAgMC01LTVaTTUgNGg4MGExIDEgMCAwIDEgMSAxdjlINFY1YTEgMSAwIDAgMSAxLTFaTTQgNjZWMThoODJ2NDhINFptNy40MTQtMjcuNDE0TDIyLjgyOSA1MCAxMS40MTQgNjEuNDE0bC0yLjgyOC0yLjgyOEwxNy4xNzEgNTBsLTguNTg1LTguNTg2IDIuODI4LTIuODI4WiIgZmlsbD0iIzAwMCIvPgo8L3N2Zz4K" class="code-block__file-icon">
    Termial
  </div> <pre class="code-block"><div data-v-7313dbe1>iex -S mix
StocksBot.get_updates()</div></pre></div> <p class="paragraph" data-v-7313dbe1>
            In the terminal you will see incoming message.
          </p> <div data-v-7313dbe1><!----> <pre class="code-block"><div data-v-7313dbe1>[
  %{
    "message" => %{
      "chat" => %{
        "first_name" => "Bender",
        "id" => 300011235,
        "last_name" => "Rodriguez",
        "type" => "private",
        "username" => "bender"
      },
      "date" => 1636549063,
      "from" => %{
        "first_name" => "Bender",
        "id" => 300011235,,
        "is_bot" => false,
        "language_code" => "ru",
        "last_name" => "Rodriguez",
        "username" => "bender"
      },
      "message_id" => 1142,
      "text" => "Hello"
    },
    "update_id" => 475896056
  }
]</div></pre></div> <p class="paragraph" data-v-7313dbe1>
            If you try to receive messages again, the answer will be the same. This happens because it is necessary to indicate to the telegram which messages have already been received. To do this, take the <i class="italic" data-v-7313dbe1>update_id</i> of the last message, increase it to one and use it as a get parameter to receive new messages.
          </p> <p class="paragraph" data-v-7313dbe1>So far, the script receives one message and stops working, but it needs to continue listening to new messages. I'll fix it now.</p> <div data-v-7313dbe1><div class="code-block__filename"><img src="/_nuxt/img/file-2.a78a4f7.svg" class="code-block__file-icon">
    stocks_bot/lib/stocks_bot.ex
  </div> <pre class="code-block"><div data-v-7313dbe1>defmodule StocksBot do
  @basic_url "https://api.telegram.org/bot&lt;Токен от Botfather>

  def get_updates(offset \\ nil) do
    with {:ok, %HTTPoison.Response{status_code: 200, body: body}} =
           updates_url(offset) |> HTTPoison.get(),
         {:ok, data} = Jason.decode(body) do

      parse_messages(data["result"])
      |> get_last_update_id()
      |> get_updates()
    end
  end

  defp parse_messages(messages) do
    Enum.each(messages, fn message ->
      IO.inspect(message)
    end)

    messages
  end

  defp get_last_update_id(_messages = []) do
    nil
  end

  defp get_last_update_id(messages) do
    List.last(messages) |> Map.fetch!("update_id")
  end

  defp updates_url(_offset = nil) do
    @basic_url &lt;> "getUpdates"
  end

  defp updates_url(offset) do
    @basic_url &lt;> "getUpdates?offset=#{offset + 1}"
  end
end
</div></pre></div></div></section> <div class="spacing_vertical-section_sub" data-v-7313dbe1></div> <section data-v-7313dbe1><h3 class="title_h3" data-v-7313dbe1>
          Polite answer
        </h3> <div class="container_content" data-v-7313dbe1><div data-v-7313dbe1><div class="code-block__filename"><img src="/_nuxt/img/file-2.a78a4f7.svg" class="code-block__file-icon">
    stocks_bot/lib/stocks_bot.ex
  </div> <pre class="code-block"><div data-v-7313dbe1>...
defp parse_messages(messages) do
  Enum.each(messages, fn message ->
    answer_to_message(message)
  end)

  messages
end

defp answer_to_message(message) do
  %{
    "message" => %{
      "chat" => %{"id" => chat_id},
      "text" => original_text
    }
  } = message

  answer = %{
    text: "Hello: #{original_text}",
    chat_id: chat_id
  }

  HTTPoison.post(
    @basic_url &lt;> "sendMessage",
    Jason.encode!(answer),
    [{"Content-Type", "application/json"}]
  )
end
</div></pre></div> <p class="paragraph" data-v-7313dbe1>
            The <i class="italic" data-v-7313dbe1>answer_to_message</i> function uses pattern matching to pick up the sender's name and the text of the incoming message to send it back to the user as a post-request.
          </p></div></section> <div class="spacing_vertical-section_sub" data-v-7313dbe1></div> <section data-v-7313dbe1><h3 class="title_h3" data-v-7313dbe1>
          Using supervisor for the application
        </h3> <div class="container_content" data-v-7313dbe1><p class="paragraph" data-v-7313dbe1>
            First step is converting app to a Genserver.
          </p> <div data-v-7313dbe1><div class="code-block__filename"><img src="/_nuxt/img/file-2.a78a4f7.svg" class="code-block__file-icon">
    stocks_bot/lib/stocks_bot.ex
  </div> <pre class="code-block"><div data-v-7313dbe1>defmodule StocksBot do
  use GenServer
  @basic_url "https://api.telegram.org/bot&lt;Токен от Botfather>

  def start_link(args) do
    GenServer.start_link(__MODULE__, :ok, name: __MODULE__)
  end

  @impl true
  def init(:ok) do
    get_updates()
    {:ok, %{}}
  end
...
</div></pre></div> <p class="paragraph" data-v-7313dbe1>
            Then this Genserver need to be added to Supervisor Tree.
          </p> <div data-v-7313dbe1><div class="code-block__filename"><img src="/_nuxt/img/file-2.a78a4f7.svg" class="code-block__file-icon">
    stocks_bot/lib/stocks_bot/application.ex 
  </div> <pre class="code-block"><div data-v-7313dbe1>defmodule StocksBot.Application do
  use Application

  @impl true
  def start(_type, _args) do
    children = [ StocksBot ]

    opts = [strategy: :one_for_one, name: StocksBot.Supervisor]
    Supervisor.start_link(children, opts)
  end
end
</div></pre></div> <ul class="links-list" data-v-7313dbe1><li><a href="https://blog.appsignal.com/2021/08/23/using-supervisors-to-organize-your-elixir-application.html" class="links-list__link">
      Article from AppSignal with good examples
    </a></li></ul></div></section> <div class="spacing_vertical-section_sub" data-v-7313dbe1></div></section> <div class="spacing_vertical-section" data-v-7313dbe1></div> <section data-v-7313dbe1><h2 class="title_h2" data-v-7313dbe1>
        Demo time
      </h2> <div class="container_content" data-v-7313dbe1><video controls loop class="post__video" data-v-7313dbe1><source src="/_nuxt/videos/demo_of_bot.50b3ca4.mp4" type="video/mp4" data-v-7313dbe1></video> <p class="paragraph" data-v-7313dbe1>
          Yes, the bot does not yet have superintelligence. In the next part, I will add user storage in the database and teach the bot to send stock price information.
        </p></div></section> <div class="spacing_vertical-section" data-v-7313dbe1></div></div></div></div> <div class="container" data-v-c385937c><a href="/ru/posts/elixir-telegram-bot">
    Русская версия
  </a></div></div></div></div><script defer src="/_nuxt/static/1644954099/posts/elixir-telegram-bot/state.js"></script><script src="/_nuxt/d28dcec.js" defer></script><script src="/_nuxt/031ce0a.js" defer></script><script src="/_nuxt/8cc0c0c.js" defer></script><script src="/_nuxt/0647000.js" defer></script><script src="/_nuxt/6428579.js" defer></script>
  </body>
</html>
