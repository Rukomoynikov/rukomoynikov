<!doctype html>
<html lang="en" dir="ltr">
	<head>
		<meta charset="utf-8" />

    <script defer data-domain="rukomoynikov.com" src="https://plausible.io/js/script.js"></script>

		<link
			rel="apple-touch-icon"
			sizes="180x180"
			href="../../favicon/apple-touch-icon.png"
		/>
		<link
			rel="icon"
			type="image/png"
			sizes="32x32"
			href="../../favicon/favicon-32x32.png"
		/>
		<link
			rel="icon"
			type="image/png"
			sizes="16x16"
			href="../../favicon/favicon-16x16.png"
		/>
		<link rel="manifest" href="../../favicon/site.webmanifest" />

		<meta name="viewport" content="width=device-width, initial-scale=1" />
		
		<link href="../../_app/immutable/assets/TwoColsContainer.6wKsjlWT.css" rel="stylesheet">
		<link href="../../_app/immutable/assets/0.CsFk-GwR.css" rel="stylesheet">
		<link href="../../_app/immutable/assets/Title.B0W284zx.css" rel="stylesheet">
		<link href="../../_app/immutable/assets/Paragraph.BRD2Py_f.css" rel="stylesheet">
		<link href="../../_app/immutable/assets/LinksList.CuLV4YNO.css" rel="stylesheet">
		<link href="../../_app/immutable/assets/CodeBlock.Df9mGtNg.css" rel="stylesheet">
		<link href="../../_app/immutable/assets/CodeBlockInline.xm-1g_C7.css" rel="stylesheet">
		<link href="../../_app/immutable/assets/5.CwIrRYg7.css" rel="stylesheet">
		<link rel="modulepreload" href="../../_app/immutable/entry/start.2Fy0_Boy.js">
		<link rel="modulepreload" href="../../_app/immutable/chunks/zI16F4aG.js">
		<link rel="modulepreload" href="../../_app/immutable/chunks/BFQ7Yu01.js">
		<link rel="modulepreload" href="../../_app/immutable/entry/app.BKuvOE9J.js">
		<link rel="modulepreload" href="../../_app/immutable/chunks/DEdac9iz.js">
		<link rel="modulepreload" href="../../_app/immutable/chunks/CP6adQlq.js">
		<link rel="modulepreload" href="../../_app/immutable/chunks/DnU_gi14.js">
		<link rel="modulepreload" href="../../_app/immutable/chunks/CHXlRE_k.js">
		<link rel="modulepreload" href="../../_app/immutable/nodes/0.Dyu0DcFV.js">
		<link rel="modulepreload" href="../../_app/immutable/chunks/B5-QeiDh.js">
		<link rel="modulepreload" href="../../_app/immutable/chunks/oKMhzk9R.js">
		<link rel="modulepreload" href="../../_app/immutable/nodes/5.BDagBtks.js">
		<link rel="modulepreload" href="../../_app/immutable/chunks/CLMN3PWg.js">
		<link rel="modulepreload" href="../../_app/immutable/chunks/BomvoTem.js">
		<link rel="modulepreload" href="../../_app/immutable/chunks/BN_lLxHm.js">
		<link rel="modulepreload" href="../../_app/immutable/chunks/DvmRkdDG.js">
		<link rel="modulepreload" href="../../_app/immutable/chunks/DBHfosdF.js">
		<link rel="modulepreload" href="../../_app/immutable/chunks/BDXTIfWS.js">
		<link rel="modulepreload" href="../../_app/immutable/chunks/9WUb61UC.js"><!--12qhfyh--><meta name="description" content="This is the first part of three in the series. There you will find creating foundation and answering to users."/> <link rel="canonical" href="/posts/elixir-telegram-bot/"/> <meta name="keywords" content="rails, ruby, typescript, react, elixir, rust"/> <meta name="twitter:image" content="https://rukomoynikov.com/_app/immutable/assets/elixir-telegram-bot-facebook-share.DD1TQ0rP.jpg?h=630&amp;w=1200"/> <meta name="robots" content="index,follow"/> <meta name="googlebot" content="index,follow"/> <meta name="twitter:card" content="summary_large_image"/> <meta name="twitter:site" content="@MRukomoynikov"/> <meta name="twitter:description" content="This is the first part of three in the series. There you will find creating foundation and answering to users."/> <meta name="twitter:image" content="https://rukomoynikov.com/_app/immutable/assets/elixir-telegram-bot-facebook-share.DD1TQ0rP.jpg?h=630&amp;w=1200"/> <meta property="og:title" content="How to create Telegram bot with Elixir - Part 1"/> <meta property="og:description" content="This is the first part of three in the series. There you will find creating foundation and answering to users."/> <meta property="og:image:url" content="https://rukomoynikov.com/_app/immutable/assets/elixir-telegram-bot-facebook-share.DD1TQ0rP.jpg?h=630&amp;w=1200"/> <meta property="og:image:width" content="1200"/> <meta property="og:image:height" content="630"/> <meta property="og:image:alt" content="How to create Telegram bot with Elixir - Part 1"/> <meta property="og:url" content="/posts/elixir-telegram-bot/"/> <meta property="og:type" content="website"/> <meta property="og:site_name" content="How to create Telegram bot with Elixir - Part 1"/><!----><title>How to create Telegram bot with Elixir - Part 1</title>
	</head>
	<body data-sveltekit-preload-data="hover">
		<div style="display: contents"><!--[--><!--[--><!----><div class="container--1200 svelte-1qhaoyr"><!--[--><div class="columns standard svelte-bivqaw"><div class="col-1 svelte-bivqaw"><!--[--><h1 class="svelte-12qhfyh"><a href="/" class="svelte-12qhfyh">Max Rukomoynikov</a></h1> <div>I speak several languages, but my favourite are [Java|Type]Script, Ruby and Elixir</div><!--]--></div> <!--[!--><!--]--></div><!--]--></div><!----> <!----><div class="container--1200 svelte-1qhaoyr"><!--[--><!----><h1 class="null svelte-139w89i"><!--[--><!---->Introduction to Telegram Bots API<!--]--><!----></h1><!----><!----> <!----><h2 class="null svelte-139w89i"><!--[--><!---->Exchanging messages with Telegram<!--]--><!----></h2><!----><!----> <div class="columns standard svelte-bivqaw"><div class="col-1 svelte-bivqaw"><!--[--><p class="paragraph svelte-puvt0u"><!--[--><!---->Telegram supports two types of integration: webhooks and polling. Webhooks it's a type when
      Telegram sends request to your server whenever bot recevied a message from the user. There
      pros and cons of that type of integration. Webhooks are more sustainable in general. For
      webhooks it's necessary to have web-server with external IP adress. This server will receive
      new messages through get requests from Telegram. During development you can use ngrock.<!--]--></p><!--]--></div> <!--[!--><!--]--></div><!----> <div class="columns standard svelte-bivqaw"><div class="col-1 svelte-bivqaw"><!--[--><p class="paragraph svelte-puvt0u"><!--[--><!---->Polling is a constant polling of the Telegram server for new messages. For polling, you do not
      need a server and an external address. Simple application that sends requests to the Telegram
      server without stopping is enough.<!--]--></p><!--]--></div> <!--[--><div class="col-2 svelte-bivqaw"><!--[--><div slot="aside"><ul class="links-list svelte-4vqykl"><!--[--><li class="svelte-4vqykl"><a href="https://core.telegram.org/bots/api#getting-updates" class="links-list__link svelte-4vqykl">Documentation about Telegram bots</a></li><!--]--></ul><!----></div><!--]--></div><!--]--></div><!----> <!----><h2 class="null svelte-139w89i"><!--[--><!---->Obtaining a token from Telegram<!--]--><!----></h2><!----><!----> <div class="columns standard svelte-bivqaw"><div class="col-1 svelte-bivqaw"><!--[--><p class="paragraph svelte-puvt0u"><!--[--><!---->The token for Telegram requests must be obtained from the BotFather bot.<!--]--></p><!--]--></div> <!--[!--><!--]--></div><!----> <div class="columns standard svelte-bivqaw"><div class="col-1 svelte-bivqaw"><!--[--><div class="video svelte-39i23f"><video controls class=""><source src="/_app/immutable/assets/api_token.CqwNeRxB.mp4" type="video/mp4"/> <!--[--><!--]--> <track src="" kind="captions" srclang="en" label="english_captions"/> Your browser does not support the video tag.</video><!----></div><!--]--></div> <!--[--><div class="col-2 svelte-bivqaw"><!--[--><div slot="aside"><ul class="links-list svelte-4vqykl"><!--[--><li class="svelte-4vqykl"><a href="https://t.me/botfather" class="links-list__link svelte-4vqykl">BotFather</a></li><!--]--></ul><!----></div><!--]--></div><!--]--></div><!----> <!----><h2 class="null svelte-139w89i"><!--[--><!---->Elixir<!--]--><!----></h2><!----><!----> <div class="columns standard svelte-bivqaw"><div class="col-1 svelte-bivqaw"><!--[--><p class="paragraph svelte-puvt0u"><!--[--><!---->Elixir is a functional programming language. Based on the another programming language Erlang.
      The main advantage of Elixir is the ability to manage a huge number of processes. These
      processes are also made in a special way, so they take up significantly less memory and
      processor time than normal computer processes.<!--]--></p><!--]--></div> <!--[--><div class="col-2 svelte-bivqaw"><!--[--><div slot="aside"><ul class="links-list svelte-4vqykl"><!--[--><li class="svelte-4vqykl"><a href="https://elixir-lang.org/install.html" class="links-list__link svelte-4vqykl">How to install Elixir one elixir-lang.org</a></li><li class="svelte-4vqykl"><a href="https://gist.github.com/mikoscz/4d2a0052d4cdaaa027bc8a8d6af1e817" class="links-list__link svelte-4vqykl">Installing with asdf package manager</a></li><!--]--></ul><!----></div><!--]--></div><!--]--></div><!----> <!----><h2 class="null svelte-139w89i"><!--[--><!---->The application<!--]--><!----></h2><!----><!----> <div class="columns standard svelte-bivqaw"><div class="col-1 svelte-bivqaw"><!--[--><p class="paragraph svelte-puvt0u"><!--[--><!---->I will gradually complicate the application. I'll start with a echo bot that sends a message
      back in response to a message. Next, I will add saving users to the database. And in the end,
      I'll try to make it a little useful - upon request from the user, the bot will send summary
      information about the stock market.<!--]--></p><!--]--></div> <!--[!--><!--]--></div><!----> <!----><h3 class="null svelte-139w89i"><!--[--><!---->Creation of the skeleton of the application and installation of the necessary tools<!--]--><!----></h3><!----><!----> <div class="columns standard svelte-bivqaw"><div class="col-1 svelte-bivqaw"><!--[--><!--[--><div class="codeBlock svelte-ipr7k2"><button class="copyButton svelte-ipr7k2">Copy</button> <!--[!--><!--]--> <!----><pre class="shiki dark-plus" style="background-color: #1E1E1E" tabindex="0"><code><span class="line"><span style="color: #DCDCAA">mix</span><span style="color: #D4D4D4"> </span><span style="color: #CE9178">new</span><span style="color: #D4D4D4"> </span><span style="color: #CE9178">stocks_bot</span><span style="color: #D4D4D4"> </span><span style="color: #569CD6">--sup</span></span></code></pre><!----></div><!--]--><!--]--></div> <!--[!--><!--]--></div><!----> <div class="columns standard svelte-bivqaw"><div class="col-1 svelte-bivqaw"><!--[--><p class="paragraph svelte-puvt0u"><!--[--><!---->First you need to create a new application. The <span class="code svelte-eb2f63"><!--[--><!---->--sup<!--]--></span><!----> option
      adds a supervisor to the application and starts it at startup. After creation, the structure of
      the application should look like this:<!--]--></p><!--]--></div> <!--[!--><!--]--></div><!----> <div class="columns standard svelte-bivqaw"><div class="col-1 svelte-bivqaw"><!--[--><!--[--><div class="codeBlock svelte-ipr7k2"><button class="copyButton svelte-ipr7k2">Copy</button> <!--[!--><!--]--> <!----><pre class="shiki dark-plus" style="background-color: #1E1E1E" tabindex="0"><code><span class="line"><span style="color: #DCDCAA">├──</span><span style="color: #D4D4D4"> </span><span style="color: #CE9178">README.md</span></span>
<span class="line"><span style="color: #DCDCAA">├──</span><span style="color: #D4D4D4"> </span><span style="color: #CE9178">lib</span></span>
<span class="line"><span style="color: #DCDCAA">│</span><span style="color: #D4D4D4"> </span><span style="color: #CE9178">├──</span><span style="color: #D4D4D4"> </span><span style="color: #CE9178">stocks_bot</span></span>
<span class="line"><span style="color: #DCDCAA">│</span><span style="color: #D4D4D4"> </span><span style="color: #CE9178">│</span><span style="color: #D4D4D4"> </span><span style="color: #CE9178">└──</span><span style="color: #D4D4D4"> </span><span style="color: #CE9178">application.ex</span></span>
<span class="line"><span style="color: #DCDCAA">│</span><span style="color: #D4D4D4"> </span><span style="color: #CE9178">└──stocks_bot.ex</span></span>
<span class="line"><span style="color: #DCDCAA">├──</span><span style="color: #D4D4D4"> </span><span style="color: #CE9178">mix.exs</span></span>
<span class="line"><span style="color: #DCDCAA">└──</span><span style="color: #D4D4D4"> </span><span style="color: #CE9178">test</span></span>
<span class="line"><span style="color: #DCDCAA">├──</span><span style="color: #D4D4D4"> </span><span style="color: #CE9178">stocks_bot_test.exs</span></span>
<span class="line"><span style="color: #DCDCAA">└──</span><span style="color: #D4D4D4"> </span><span style="color: #CE9178">test_helper.exs</span></span></code></pre><!----></div><!--]--><!--]--></div> <!--[!--><!--]--></div><!----> <div class="columns standard svelte-bivqaw"><div class="col-1 svelte-bivqaw"><!--[--><p class="paragraph svelte-puvt0u"><!--[--><!---->Additionally, you need to install HTTPoison to send requests and Jason to work with JSON in
      responses from the Telegram server.<!--]--></p><!--]--></div> <!--[!--><!--]--></div><!----> <div class="columns standard svelte-bivqaw"><div class="col-1 svelte-bivqaw"><!--[--><!--[--><div class="codeBlock svelte-ipr7k2 codeBlock--with-filename"><button class="copyButton svelte-ipr7k2">Copy</button> <!--[--><div class="fileName svelte-ipr7k2">File: stocks_bot/mix.exs</div><!--]--> <!----><pre class="shiki dark-plus" style="background-color: #1E1E1E" tabindex="0"><code><span class="line"><span style="color: #C586C0">defp</span><span style="color: #D4D4D4"> </span><span style="color: #DCDCAA">deps</span><span style="color: #D4D4D4"> </span><span style="color: #C586C0">do</span></span>
<span class="line"><span style="color: #D4D4D4">  [</span></span>
<span class="line"><span style="color: #D4D4D4">    {:httpoison, </span><span style="color: #CE9178">&quot;~&gt; 1.8&quot;</span><span style="color: #D4D4D4">},</span></span>
<span class="line"><span style="color: #D4D4D4">    {:jason, </span><span style="color: #CE9178">&quot;~&gt; 1.2&quot;</span><span style="color: #D4D4D4">}</span></span>
<span class="line"><span style="color: #D4D4D4">  ]</span></span>
<span class="line"><span style="color: #C586C0">end</span></span></code></pre><!----></div><!--]--><!--]--></div> <!--[!--><!--]--></div><!----> <!----><h2 class="null svelte-139w89i"><!--[--><!---->Receiving user message<!--]--><!----></h2><!----><!----> <div class="columns standard svelte-bivqaw"><div class="col-1 svelte-bivqaw"><!--[--><!--[--><div class="codeBlock svelte-ipr7k2 codeBlock--with-filename"><button class="copyButton svelte-ipr7k2">Copy</button> <!--[--><div class="fileName svelte-ipr7k2">File: stocks_bot/lib/stocks_bot.ex</div><!--]--> <!----><pre class="shiki dark-plus" style="background-color: #1E1E1E" tabindex="0"><code><span class="line"><span style="color: #C586C0">defmodule</span><span style="color: #D4D4D4"> </span><span style="color: #4EC9B0">StocksBot</span><span style="color: #D4D4D4"> </span><span style="color: #C586C0">do</span></span>
<span class="line"><span style="color: #D4D4D4">  </span><span style="color: #9CDCFE">@basic_url</span><span style="color: #D4D4D4"> </span><span style="color: #CE9178">&quot;https://api.telegram.org/bot&quot;</span><span style="color: #D4D4D4"> &lt;&gt; </span><span style="color: #CE9178">&quot;Token from BotFather&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D4D4D4">  </span><span style="color: #C586C0">def</span><span style="color: #D4D4D4"> </span><span style="color: #DCDCAA">get_updates</span><span style="color: #D4D4D4">(offset \\ </span><span style="color: #569CD6">nil</span><span style="color: #D4D4D4">) </span><span style="color: #C586C0">do</span></span>
<span class="line"><span style="color: #D4D4D4">    </span><span style="color: #C586C0">with</span><span style="color: #D4D4D4"> {:ok, %</span><span style="color: #4EC9B0">HTTPoison</span><span style="color: #D4D4D4">.</span><span style="color: #4EC9B0">Response</span><span style="color: #D4D4D4">{status_code: </span><span style="color: #B5CEA8">200</span><span style="color: #D4D4D4">, body: body}} =</span></span>
<span class="line"><span style="color: #D4D4D4">           </span><span style="color: #DCDCAA">updates_url</span><span style="color: #D4D4D4">(offset) |&gt; </span><span style="color: #4EC9B0">HTTPoison</span><span style="color: #D4D4D4">.</span><span style="color: #DCDCAA">get</span><span style="color: #D4D4D4">(),</span></span>
<span class="line"><span style="color: #D4D4D4">         {:ok, data} = </span><span style="color: #4EC9B0">Jason</span><span style="color: #D4D4D4">.</span><span style="color: #DCDCAA">decode</span><span style="color: #D4D4D4">(body) </span><span style="color: #C586C0">do</span></span>
<span class="line"><span style="color: #D4D4D4">      </span><span style="color: #4EC9B0">IO</span><span style="color: #D4D4D4">.</span><span style="color: #DCDCAA">inspect</span><span style="color: #D4D4D4">(data[</span><span style="color: #CE9178">&quot;result&quot;</span><span style="color: #D4D4D4">])</span></span>
<span class="line"><span style="color: #D4D4D4">    </span><span style="color: #C586C0">end</span></span>
<span class="line"><span style="color: #D4D4D4">  </span><span style="color: #C586C0">end</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D4D4D4">  </span><span style="color: #C586C0">defp</span><span style="color: #D4D4D4"> </span><span style="color: #DCDCAA">updates_url</span><span style="color: #D4D4D4">(</span><span style="color: #6A9955">_offset</span><span style="color: #D4D4D4"> = </span><span style="color: #569CD6">nil</span><span style="color: #D4D4D4">) </span><span style="color: #C586C0">do</span></span>
<span class="line"><span style="color: #D4D4D4">    </span><span style="color: #9CDCFE">@basic_url</span><span style="color: #D4D4D4"> &lt;&gt; </span><span style="color: #CE9178">&quot;/getUpdates&quot;</span></span>
<span class="line"><span style="color: #D4D4D4">  </span><span style="color: #C586C0">end</span></span>
<span class="line"><span style="color: #C586C0">end</span></span></code></pre><!----></div><!--]--><!--]--></div> <!--[--><div class="col-2 svelte-bivqaw"><!--[--><div slot="aside"><ul class="links-list svelte-4vqykl"><!--[--><li class="svelte-4vqykl"><a href="https://core.telegram.org/bots/api#getting-updates" class="links-list__link svelte-4vqykl">Documentation about Telegram bots</a></li><!--]--></ul><!----></div><!--]--></div><!--]--></div><!----> <div class="columns standard svelte-bivqaw"><div class="col-1 svelte-bivqaw"><!--[--><p class="paragraph svelte-puvt0u"><!--[--><!---->Now you can try how it works. Send your bot a message. Then open your terminal and enter these
      commands.<!--]--></p><!--]--></div> <!--[!--><!--]--></div><!----> <div class="columns standard svelte-bivqaw"><div class="col-1 svelte-bivqaw"><!--[--><!--[--><div class="codeBlock svelte-ipr7k2"><button class="copyButton svelte-ipr7k2">Copy</button> <!--[!--><!--]--> <!----><pre class="shiki dark-plus" style="background-color: #1E1E1E" tabindex="0"><code><span class="line"><span style="color: #DCDCAA">iex</span><span style="color: #D4D4D4"> </span><span style="color: #569CD6">-S</span><span style="color: #D4D4D4"> </span><span style="color: #CE9178">mix</span></span>
<span class="line"><span style="color: #DCDCAA">StocksBot.get_updates</span><span style="color: #D4D4D4">()</span></span></code></pre><!----></div><!--]--><!--]--></div> <!--[!--><!--]--></div><!----> <div class="columns standard svelte-bivqaw"><div class="col-1 svelte-bivqaw"><!--[--><p class="paragraph svelte-puvt0u"><!--[--><!---->In the terminal you will see incoming message:<!--]--></p><!--]--></div> <!--[!--><!--]--></div><!----> <div class="columns standard svelte-bivqaw"><div class="col-1 svelte-bivqaw"><!--[--><!--[--><div class="codeBlock svelte-ipr7k2"><button class="copyButton svelte-ipr7k2">Copy</button> <!--[!--><!--]--> <!----><pre class="shiki dark-plus" style="background-color: #1E1E1E" tabindex="0"><code><span class="line"><span style="color: #D4D4D4">[</span></span>
<span class="line"><span style="color: #D4D4D4">  %{</span></span>
<span class="line"><span style="color: #D4D4D4">    </span><span style="color: #CE9178">&quot;message&quot;</span><span style="color: #D4D4D4"> =&gt; %{</span></span>
<span class="line"><span style="color: #D4D4D4">      </span><span style="color: #CE9178">&quot;chat&quot;</span><span style="color: #D4D4D4"> =&gt; %{</span></span>
<span class="line"><span style="color: #D4D4D4">        </span><span style="color: #CE9178">&quot;first_name&quot;</span><span style="color: #D4D4D4"> =&gt; </span><span style="color: #CE9178">&quot;Bender&quot;</span><span style="color: #D4D4D4">,</span></span>
<span class="line"><span style="color: #D4D4D4">        </span><span style="color: #CE9178">&quot;id&quot;</span><span style="color: #D4D4D4"> =&gt; </span><span style="color: #B5CEA8">300011235</span><span style="color: #D4D4D4">,</span></span>
<span class="line"><span style="color: #D4D4D4">        </span><span style="color: #CE9178">&quot;last_name&quot;</span><span style="color: #D4D4D4"> =&gt; </span><span style="color: #CE9178">&quot;Rodriguez&quot;</span><span style="color: #D4D4D4">,</span></span>
<span class="line"><span style="color: #D4D4D4">        </span><span style="color: #CE9178">&quot;type&quot;</span><span style="color: #D4D4D4"> =&gt; </span><span style="color: #CE9178">&quot;private&quot;</span><span style="color: #D4D4D4">,</span></span>
<span class="line"><span style="color: #D4D4D4">        </span><span style="color: #CE9178">&quot;username&quot;</span><span style="color: #D4D4D4"> =&gt; </span><span style="color: #CE9178">&quot;bender&quot;</span></span>
<span class="line"><span style="color: #D4D4D4">      },</span></span>
<span class="line"><span style="color: #D4D4D4">      </span><span style="color: #CE9178">&quot;date&quot;</span><span style="color: #D4D4D4"> =&gt; </span><span style="color: #B5CEA8">1636549063</span><span style="color: #D4D4D4">,</span></span>
<span class="line"><span style="color: #D4D4D4">      </span><span style="color: #CE9178">&quot;from&quot;</span><span style="color: #D4D4D4"> =&gt; %{</span></span>
<span class="line"><span style="color: #D4D4D4">        </span><span style="color: #CE9178">&quot;first_name&quot;</span><span style="color: #D4D4D4"> =&gt; </span><span style="color: #CE9178">&quot;Bender&quot;</span><span style="color: #D4D4D4">,</span></span>
<span class="line"><span style="color: #D4D4D4">        </span><span style="color: #CE9178">&quot;id&quot;</span><span style="color: #D4D4D4"> =&gt; </span><span style="color: #B5CEA8">300011235</span><span style="color: #D4D4D4">,,</span></span>
<span class="line"><span style="color: #D4D4D4">        </span><span style="color: #CE9178">&quot;is_bot&quot;</span><span style="color: #D4D4D4"> =&gt; </span><span style="color: #569CD6">false</span><span style="color: #D4D4D4">,</span></span>
<span class="line"><span style="color: #D4D4D4">        </span><span style="color: #CE9178">&quot;language_code&quot;</span><span style="color: #D4D4D4"> =&gt; </span><span style="color: #CE9178">&quot;ru&quot;</span><span style="color: #D4D4D4">,</span></span>
<span class="line"><span style="color: #D4D4D4">        </span><span style="color: #CE9178">&quot;last_name&quot;</span><span style="color: #D4D4D4"> =&gt; </span><span style="color: #CE9178">&quot;Rodriguez&quot;</span><span style="color: #D4D4D4">,</span></span>
<span class="line"><span style="color: #D4D4D4">        </span><span style="color: #CE9178">&quot;username&quot;</span><span style="color: #D4D4D4"> =&gt; </span><span style="color: #CE9178">&quot;bender&quot;</span></span>
<span class="line"><span style="color: #D4D4D4">      },</span></span>
<span class="line"><span style="color: #D4D4D4">      </span><span style="color: #CE9178">&quot;message_id&quot;</span><span style="color: #D4D4D4"> =&gt; </span><span style="color: #B5CEA8">1142</span><span style="color: #D4D4D4">,</span></span>
<span class="line"><span style="color: #D4D4D4">      </span><span style="color: #CE9178">&quot;text&quot;</span><span style="color: #D4D4D4"> =&gt; </span><span style="color: #CE9178">&quot;Hello&quot;</span></span>
<span class="line"><span style="color: #D4D4D4">    },</span></span>
<span class="line"><span style="color: #D4D4D4">    </span><span style="color: #CE9178">&quot;update_id&quot;</span><span style="color: #D4D4D4"> =&gt; </span><span style="color: #B5CEA8">475896056</span></span>
<span class="line"><span style="color: #D4D4D4">  }</span></span>
<span class="line"><span style="color: #D4D4D4">]</span></span></code></pre><!----></div><!--]--><!--]--></div> <!--[!--><!--]--></div><!----> <div class="columns standard svelte-bivqaw"><div class="col-1 svelte-bivqaw"><!--[--><p class="paragraph svelte-puvt0u"><!--[--><!---->If you try to receive messages again, the answer will be the same. This happens because it is
      necessary to indicate to the telegram which messages have already been received. To do this,
      take the <span class="code svelte-eb2f63"><!--[--><!---->update_id<!--]--></span><!----> of the last message, increase it to one and
      use it as a get parameter to receive new messages.<!--]--></p><!--]--></div> <!--[!--><!--]--></div><!----> <div class="columns standard svelte-bivqaw"><div class="col-1 svelte-bivqaw"><!--[--><p class="paragraph svelte-puvt0u"><!--[--><!---->So far, the script receives one message and stops working, but it needs to continue listening
      to new messages. I'll fix it now.<!--]--></p><!--]--></div> <!--[!--><!--]--></div><!----> <div class="columns standard svelte-bivqaw"><div class="col-1 svelte-bivqaw"><!--[--><!--[--><div class="codeBlock svelte-ipr7k2 codeBlock--with-filename"><button class="copyButton svelte-ipr7k2">Copy</button> <!--[--><div class="fileName svelte-ipr7k2">File: stocks_bot/lib/stocks_bot.ex</div><!--]--> <!----><pre class="shiki dark-plus" style="background-color: #1E1E1E" tabindex="0"><code><span class="line"><span style="color: #C586C0">defmodule</span><span style="color: #D4D4D4"> </span><span style="color: #4EC9B0">StocksBot</span><span style="color: #D4D4D4"> </span><span style="color: #C586C0">do</span></span>
<span class="line"><span style="color: #D4D4D4">  </span><span style="color: #9CDCFE">@basic_url</span><span style="color: #D4D4D4"> </span><span style="color: #CE9178">&quot;https://api.telegram.org/bot&quot;</span><span style="color: #D4D4D4"> &lt;&gt; </span><span style="color: #CE9178">&quot;Token from BotFather&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D4D4D4">  </span><span style="color: #C586C0">def</span><span style="color: #D4D4D4"> </span><span style="color: #DCDCAA">get_updates</span><span style="color: #D4D4D4">(offset \\ </span><span style="color: #569CD6">nil</span><span style="color: #D4D4D4">) </span><span style="color: #C586C0">do</span></span>
<span class="line"><span style="color: #D4D4D4">    </span><span style="color: #C586C0">with</span><span style="color: #D4D4D4"> {:ok, %</span><span style="color: #4EC9B0">HTTPoison</span><span style="color: #D4D4D4">.</span><span style="color: #4EC9B0">Response</span><span style="color: #D4D4D4">{status_code: </span><span style="color: #B5CEA8">200</span><span style="color: #D4D4D4">, body: body}} =</span></span>
<span class="line"><span style="color: #D4D4D4">           </span><span style="color: #DCDCAA">updates_url</span><span style="color: #D4D4D4">(offset) |&gt; </span><span style="color: #4EC9B0">HTTPoison</span><span style="color: #D4D4D4">.</span><span style="color: #DCDCAA">get</span><span style="color: #D4D4D4">(),</span></span>
<span class="line"><span style="color: #D4D4D4">         {:ok, data} = </span><span style="color: #4EC9B0">Jason</span><span style="color: #D4D4D4">.</span><span style="color: #DCDCAA">decode</span><span style="color: #D4D4D4">(body) </span><span style="color: #C586C0">do</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D4D4D4">      </span><span style="color: #DCDCAA">parse_messages</span><span style="color: #D4D4D4">(data[</span><span style="color: #CE9178">&quot;result&quot;</span><span style="color: #D4D4D4">])</span></span>
<span class="line"><span style="color: #D4D4D4">      |&gt; </span><span style="color: #DCDCAA">get_last_update_id</span><span style="color: #D4D4D4">()</span></span>
<span class="line"><span style="color: #D4D4D4">      |&gt; </span><span style="color: #DCDCAA">get_updates</span><span style="color: #D4D4D4">()</span></span>
<span class="line"><span style="color: #D4D4D4">    </span><span style="color: #C586C0">end</span></span>
<span class="line"><span style="color: #D4D4D4">  </span><span style="color: #C586C0">end</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D4D4D4">  </span><span style="color: #C586C0">defp</span><span style="color: #D4D4D4"> </span><span style="color: #DCDCAA">parse_messages</span><span style="color: #D4D4D4">(messages) </span><span style="color: #C586C0">do</span></span>
<span class="line"><span style="color: #D4D4D4">    </span><span style="color: #4EC9B0">Enum</span><span style="color: #D4D4D4">.</span><span style="color: #DCDCAA">each</span><span style="color: #D4D4D4">(messages, </span><span style="color: #C586C0">fn</span><span style="color: #D4D4D4"> message -&gt;</span></span>
<span class="line"><span style="color: #D4D4D4">      </span><span style="color: #4EC9B0">IO</span><span style="color: #D4D4D4">.</span><span style="color: #DCDCAA">inspect</span><span style="color: #D4D4D4">(message)</span></span>
<span class="line"><span style="color: #D4D4D4">    </span><span style="color: #C586C0">end</span><span style="color: #D4D4D4">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D4D4D4">    messages</span></span>
<span class="line"><span style="color: #D4D4D4">  </span><span style="color: #C586C0">end</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D4D4D4">  </span><span style="color: #C586C0">defp</span><span style="color: #D4D4D4"> </span><span style="color: #DCDCAA">get_last_update_id</span><span style="color: #D4D4D4">([]), do: </span><span style="color: #569CD6">nil</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D4D4D4">  </span><span style="color: #C586C0">defp</span><span style="color: #D4D4D4"> </span><span style="color: #DCDCAA">get_last_update_id</span><span style="color: #D4D4D4">(messages) </span><span style="color: #C586C0">do</span></span>
<span class="line"><span style="color: #D4D4D4">    </span><span style="color: #4EC9B0">List</span><span style="color: #D4D4D4">.</span><span style="color: #DCDCAA">last</span><span style="color: #D4D4D4">(messages) |&gt; </span><span style="color: #4EC9B0">Map</span><span style="color: #D4D4D4">.</span><span style="color: #DCDCAA">fetch!</span><span style="color: #D4D4D4">(</span><span style="color: #CE9178">&quot;update_id&quot;</span><span style="color: #D4D4D4">)</span></span>
<span class="line"><span style="color: #D4D4D4">  </span><span style="color: #C586C0">end</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D4D4D4">  </span><span style="color: #C586C0">defp</span><span style="color: #D4D4D4"> </span><span style="color: #DCDCAA">updates_url</span><span style="color: #D4D4D4">(</span><span style="color: #6A9955">_offset</span><span style="color: #D4D4D4"> = </span><span style="color: #569CD6">nil</span><span style="color: #D4D4D4">) </span><span style="color: #C586C0">do</span></span>
<span class="line"><span style="color: #D4D4D4">    </span><span style="color: #9CDCFE">@basic_url</span><span style="color: #D4D4D4"> &lt;&gt; </span><span style="color: #CE9178">&quot;/getUpdates&quot;</span></span>
<span class="line"><span style="color: #D4D4D4">  </span><span style="color: #C586C0">end</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D4D4D4">  </span><span style="color: #C586C0">defp</span><span style="color: #D4D4D4"> </span><span style="color: #DCDCAA">updates_url</span><span style="color: #D4D4D4">(offset) </span><span style="color: #C586C0">do</span></span>
<span class="line"><span style="color: #D4D4D4">    </span><span style="color: #9CDCFE">@basic_url</span><span style="color: #D4D4D4"> &lt;&gt; </span><span style="color: #CE9178">&quot;/getUpdates?offset=</span><span style="color: #569CD6">#{</span><span style="color: #D4D4D4">offset + </span><span style="color: #B5CEA8">1</span><span style="color: #569CD6">}</span><span style="color: #CE9178">&quot;</span></span>
<span class="line"><span style="color: #D4D4D4">  </span><span style="color: #C586C0">end</span></span>
<span class="line"><span style="color: #C586C0">end</span></span></code></pre><!----></div><!--]--><!--]--></div> <!--[!--><!--]--></div><!----> <!----><h3 class="null svelte-139w89i"><!--[--><!---->Polite answer<!--]--><!----></h3><!----><!----> <div class="columns standard svelte-bivqaw"><div class="col-1 svelte-bivqaw"><!--[--><!--[--><div class="codeBlock svelte-ipr7k2 codeBlock--with-filename"><button class="copyButton svelte-ipr7k2">Copy</button> <!--[--><div class="fileName svelte-ipr7k2">File: stocks_bot/lib/stocks_bot.ex</div><!--]--> <!----><pre class="shiki dark-plus" style="background-color: #1E1E1E" tabindex="0"><code><span class="line"><span style="color: #C586C0">defp</span><span style="color: #D4D4D4"> </span><span style="color: #DCDCAA">parse_messages</span><span style="color: #D4D4D4">(messages) </span><span style="color: #C586C0">do</span></span>
<span class="line"><span style="color: #D4D4D4">  </span><span style="color: #4EC9B0">Enum</span><span style="color: #D4D4D4">.</span><span style="color: #DCDCAA">each</span><span style="color: #D4D4D4">(messages, </span><span style="color: #C586C0">fn</span><span style="color: #D4D4D4"> message -&gt;</span></span>
<span class="line"><span style="color: #D4D4D4">    </span><span style="color: #DCDCAA">answer_to_message</span><span style="color: #D4D4D4">(message)</span></span>
<span class="line"><span style="color: #D4D4D4">  </span><span style="color: #C586C0">end</span><span style="color: #D4D4D4">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D4D4D4">  messages</span></span>
<span class="line"><span style="color: #C586C0">end</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C586C0">defp</span><span style="color: #D4D4D4"> </span><span style="color: #DCDCAA">answer_to_message</span><span style="color: #D4D4D4">(message) </span><span style="color: #C586C0">do</span></span>
<span class="line"><span style="color: #D4D4D4">  %{</span></span>
<span class="line"><span style="color: #D4D4D4">    </span><span style="color: #CE9178">&quot;message&quot;</span><span style="color: #D4D4D4"> =&gt; %{</span></span>
<span class="line"><span style="color: #D4D4D4">      </span><span style="color: #CE9178">&quot;chat&quot;</span><span style="color: #D4D4D4"> =&gt; %{</span><span style="color: #CE9178">&quot;id&quot;</span><span style="color: #D4D4D4"> =&gt; chat_id},</span></span>
<span class="line"><span style="color: #D4D4D4">      </span><span style="color: #CE9178">&quot;text&quot;</span><span style="color: #D4D4D4"> =&gt; original_text</span></span>
<span class="line"><span style="color: #D4D4D4">    }</span></span>
<span class="line"><span style="color: #D4D4D4">  } = message</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D4D4D4">  answer = %{</span></span>
<span class="line"><span style="color: #D4D4D4">    text: </span><span style="color: #CE9178">&quot;Hello: </span><span style="color: #569CD6">#{</span><span style="color: #D4D4D4">original_text</span><span style="color: #569CD6">}</span><span style="color: #CE9178">&quot;</span><span style="color: #D4D4D4">,</span></span>
<span class="line"><span style="color: #D4D4D4">    chat_id: chat_id</span></span>
<span class="line"><span style="color: #D4D4D4">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D4D4D4">  </span><span style="color: #4EC9B0">HTTPoison</span><span style="color: #D4D4D4">.</span><span style="color: #DCDCAA">post</span><span style="color: #D4D4D4">(</span></span>
<span class="line"><span style="color: #D4D4D4">    </span><span style="color: #9CDCFE">@basic_url</span><span style="color: #D4D4D4"> &lt;&gt; </span><span style="color: #CE9178">&quot;/sendMessage&quot;</span><span style="color: #D4D4D4">,</span></span>
<span class="line"><span style="color: #D4D4D4">    </span><span style="color: #4EC9B0">Jason</span><span style="color: #D4D4D4">.</span><span style="color: #DCDCAA">encode!</span><span style="color: #D4D4D4">(answer),</span></span>
<span class="line"><span style="color: #D4D4D4">    [{</span><span style="color: #CE9178">&quot;Content-Type&quot;</span><span style="color: #D4D4D4">, </span><span style="color: #CE9178">&quot;application/json&quot;</span><span style="color: #D4D4D4">}]</span></span>
<span class="line"><span style="color: #D4D4D4">  )</span></span>
<span class="line"><span style="color: #C586C0">end</span></span></code></pre><!----></div><!--]--><!--]--></div> <!--[!--><!--]--></div><!----> <div class="columns standard svelte-bivqaw"><div class="col-1 svelte-bivqaw"><!--[--><p class="paragraph svelte-puvt0u"><!--[--><!---->The <span class="code svelte-eb2f63"><!--[--><!---->answer_to_message<!--]--></span><!----> function uses pattern matching to pick
      up the sender's name and the text of the incoming message to send it back to the user as a post-request.<!--]--></p><!--]--></div> <!--[!--><!--]--></div><!----> <!----><h3 class="null svelte-139w89i"><!--[--><!---->Using supervisor for the application<!--]--><!----></h3><!----><!----> <div class="columns standard svelte-bivqaw"><div class="col-1 svelte-bivqaw"><!--[--><p class="paragraph svelte-puvt0u"><!--[--><!---->First step is converting app to a Genserver.<!--]--></p><!--]--></div> <!--[!--><!--]--></div><!----> <div class="columns standard svelte-bivqaw"><div class="col-1 svelte-bivqaw"><!--[--><!--[--><div class="codeBlock svelte-ipr7k2 codeBlock--with-filename"><button class="copyButton svelte-ipr7k2">Copy</button> <!--[--><div class="fileName svelte-ipr7k2">File: stocks_bot/lib/stocks_bot.ex</div><!--]--> <!----><pre class="shiki dark-plus" style="background-color: #1E1E1E" tabindex="0"><code><span class="line"><span style="color: #C586C0">defmodule</span><span style="color: #D4D4D4"> </span><span style="color: #4EC9B0">StocksBot</span><span style="color: #D4D4D4"> </span><span style="color: #C586C0">do</span></span>
<span class="line"><span style="color: #D4D4D4">  </span><span style="color: #C586C0">use</span><span style="color: #D4D4D4"> </span><span style="color: #4EC9B0">GenServer</span></span>
<span class="line"><span style="color: #D4D4D4">  </span><span style="color: #9CDCFE">@basic_url</span><span style="color: #D4D4D4"> </span><span style="color: #CE9178">&quot;https://api.telegram.org/bot&quot;</span><span style="color: #D4D4D4"> &lt;&gt; </span><span style="color: #CE9178">&quot;Token from BotFather&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D4D4D4">  </span><span style="color: #C586C0">def</span><span style="color: #D4D4D4"> </span><span style="color: #DCDCAA">start_link</span><span style="color: #D4D4D4">(args) </span><span style="color: #C586C0">do</span></span>
<span class="line"><span style="color: #D4D4D4">    </span><span style="color: #4EC9B0">GenServer</span><span style="color: #D4D4D4">.</span><span style="color: #DCDCAA">start_link</span><span style="color: #D4D4D4">(</span><span style="color: #569CD6">__MODULE__</span><span style="color: #D4D4D4">, :ok, name: </span><span style="color: #569CD6">__MODULE__</span><span style="color: #D4D4D4">)</span></span>
<span class="line"><span style="color: #D4D4D4">  </span><span style="color: #C586C0">end</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D4D4D4">  </span><span style="color: #9CDCFE">@impl</span><span style="color: #D4D4D4"> </span><span style="color: #569CD6">true</span></span>
<span class="line"><span style="color: #D4D4D4">  </span><span style="color: #C586C0">def</span><span style="color: #D4D4D4"> </span><span style="color: #DCDCAA">init</span><span style="color: #D4D4D4">(:ok) </span><span style="color: #C586C0">do</span></span>
<span class="line"><span style="color: #D4D4D4">    </span><span style="color: #DCDCAA">get_updates</span><span style="color: #D4D4D4">()</span></span>
<span class="line"><span style="color: #D4D4D4">    {:ok, %{}}</span></span>
<span class="line"><span style="color: #D4D4D4">  </span><span style="color: #C586C0">end</span></span>
<span class="line"><span style="color: #C586C0">end</span></span></code></pre><!----></div><!--]--><!--]--></div> <!--[!--><!--]--></div><!----> <div class="columns standard svelte-bivqaw"><div class="col-1 svelte-bivqaw"><!--[--><p class="paragraph svelte-puvt0u"><!--[--><!---->Then this Genserver need to be added to Supervisor Tree.<!--]--></p><!--]--></div> <!--[!--><!--]--></div><!----> <div class="columns standard svelte-bivqaw"><div class="col-1 svelte-bivqaw"><!--[--><!--[--><div class="codeBlock svelte-ipr7k2 codeBlock--with-filename"><button class="copyButton svelte-ipr7k2">Copy</button> <!--[--><div class="fileName svelte-ipr7k2">File: stocks_bot/lib/stocks_bot/application.ex</div><!--]--> <!----><pre class="shiki dark-plus" style="background-color: #1E1E1E" tabindex="0"><code><span class="line"><span style="color: #C586C0">defmodule</span><span style="color: #D4D4D4"> </span><span style="color: #4EC9B0">StocksBot</span><span style="color: #D4D4D4">.</span><span style="color: #4EC9B0">Application</span><span style="color: #D4D4D4"> </span><span style="color: #C586C0">do</span></span>
<span class="line"><span style="color: #D4D4D4">  </span><span style="color: #C586C0">use</span><span style="color: #D4D4D4"> </span><span style="color: #4EC9B0">Application</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D4D4D4">  </span><span style="color: #9CDCFE">@impl</span><span style="color: #D4D4D4"> </span><span style="color: #569CD6">true</span></span>
<span class="line"><span style="color: #D4D4D4">  </span><span style="color: #C586C0">def</span><span style="color: #D4D4D4"> </span><span style="color: #DCDCAA">start</span><span style="color: #D4D4D4">(</span><span style="color: #6A9955">_type</span><span style="color: #D4D4D4">, </span><span style="color: #6A9955">_args</span><span style="color: #D4D4D4">) </span><span style="color: #C586C0">do</span></span>
<span class="line"><span style="color: #D4D4D4">    children = [ </span><span style="color: #4EC9B0">StocksBot</span><span style="color: #D4D4D4"> ]</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D4D4D4">    opts = [strategy: :one_for_one, name: </span><span style="color: #4EC9B0">StocksBot</span><span style="color: #D4D4D4">.</span><span style="color: #4EC9B0">Supervisor</span><span style="color: #D4D4D4">]</span></span>
<span class="line"><span style="color: #D4D4D4">    </span><span style="color: #4EC9B0">Supervisor</span><span style="color: #D4D4D4">.</span><span style="color: #DCDCAA">start_link</span><span style="color: #D4D4D4">(children, opts)</span></span>
<span class="line"><span style="color: #D4D4D4">  </span><span style="color: #C586C0">end</span></span>
<span class="line"><span style="color: #C586C0">end</span></span></code></pre><!----></div><!--]--><!--]--></div> <!--[--><div class="col-2 svelte-bivqaw"><!--[--><div slot="aside"><ul class="links-list svelte-4vqykl"><!--[--><li class="svelte-4vqykl"><a href="https://blog.appsignal.com/2021/08/23/using-supervisors-to-organize-your-elixir-application.html" class="links-list__link svelte-4vqykl">Article from AppSignal with good examples</a></li><!--]--></ul><!----></div><!--]--></div><!--]--></div><!----> <!----><h2 class="null svelte-139w89i"><!--[--><!---->Demo time<!--]--><!----></h2><!----><!----> <div class="columns standard svelte-bivqaw"><div class="col-1 svelte-bivqaw"><!--[--><div class="video svelte-39i23f"><video controls class=""><source src="/_app/immutable/assets/demo_of_bot.Bnn26c6O.mp4" type="video/mp4"/> <!--[--><!--]--> <track src="" kind="captions" srclang="en" label="english_captions"/> Your browser does not support the video tag.</video><!----></div><!--]--></div> <!--[--><div class="col-2 svelte-bivqaw"><!--[--><div slot="aside"><ul class="links-list svelte-4vqykl"><!--[--><li class="svelte-4vqykl"><a href="https://github.com/Rukomoynikov/telegram-bot-article" class="links-list__link svelte-4vqykl">Github repository with bot source code</a></li><!--]--></ul><!----></div><!--]--></div><!--]--></div><!----> <div class="columns standard svelte-bivqaw"><div class="col-1 svelte-bivqaw"><!--[--><p class="paragraph svelte-puvt0u"><!--[--><!---->Yes, the bot does not yet have superintelligence. In the next part, I will add user storage in
      the database and teach the bot to send stock price information.<!--]--></p><!--]--></div> <!--[!--><!--]--></div><!----><!--]--></div><!----><!----><!----><!--]--> <!--[!--><!--]--><!--]-->
			
			<script>
				{
					__sveltekit_1e0jyoh = {
						base: new URL("../..", location).pathname.slice(0, -1)
					};

					const element = document.currentScript.parentElement;

					Promise.all([
						import("../../_app/immutable/entry/start.2Fy0_Boy.js"),
						import("../../_app/immutable/entry/app.BKuvOE9J.js")
					]).then(([kit, app]) => {
						kit.start(app, element, {
							node_ids: [0, 5],
							data: [null,null],
							form: null,
							error: null
						});
					});
				}
			</script>
		</div>
	</body>
</html>
