<!doctype html>
<html lang="en" dir="ltr">
	<head>
		<meta charset="utf-8" />

		<link
			rel="apple-touch-icon"
			sizes="180x180"
			href="../../favicon/apple-touch-icon.png"
		/>
		<link
			rel="icon"
			type="image/png"
			sizes="32x32"
			href="../../favicon/favicon-32x32.png"
		/>
		<link
			rel="icon"
			type="image/png"
			sizes="16x16"
			href="../../favicon/favicon-16x16.png"
		/>
		<link rel="manifest" href="../../favicon/site.webmanifest" />

		<meta name="viewport" content="width=device-width, initial-scale=1" />
		
		<link href="../../_app/immutable/assets/0.DbhTkV5p.css" rel="stylesheet">
		<link href="../../_app/immutable/assets/TwoColsContainer.Cfns4Auz.css" rel="stylesheet">
		<link href="../../_app/immutable/assets/Title.r_T7jWS_.css" rel="stylesheet">
		<link href="../../_app/immutable/assets/Paragraph.aDFaLfzd.css" rel="stylesheet">
		<link href="../../_app/immutable/assets/LinksList.6PqA1Dza.css" rel="stylesheet">
		<link href="../../_app/immutable/assets/CodeBlock.CobIdgon.css" rel="stylesheet">
		<link rel="modulepreload" href="../../_app/immutable/entry/start.B7qkGNvi.js">
		<link rel="modulepreload" href="../../_app/immutable/chunks/entry.BuVwwvhj.js">
		<link rel="modulepreload" href="../../_app/immutable/chunks/utils.CrDVYUnt.js">
		<link rel="modulepreload" href="../../_app/immutable/entry/app.CLiriMFa.js">
		<link rel="modulepreload" href="../../_app/immutable/chunks/legacy.kROiCmhR.js">
		<link rel="modulepreload" href="../../_app/immutable/chunks/stores.DOwEDUh-.js">
		<link rel="modulepreload" href="../../_app/immutable/chunks/render.CSCXmMM-.js">
		<link rel="modulepreload" href="../../_app/immutable/chunks/props.D51blVrW.js">
		<link rel="modulepreload" href="../../_app/immutable/nodes/0.Dc_BexMn.js">
		<link rel="modulepreload" href="../../_app/immutable/chunks/TwoColsContainer.zeqId5Fh.js">
		<link rel="modulepreload" href="../../_app/immutable/chunks/index.CKscP9ss.js">
		<link rel="modulepreload" href="../../_app/immutable/nodes/9.BL94ps67.js">
		<link rel="modulepreload" href="../../_app/immutable/chunks/Title.BHUhat24.js">
		<link rel="modulepreload" href="../../_app/immutable/chunks/lifecycle.DrXUT_Pr.js">
		<link rel="modulepreload" href="../../_app/immutable/chunks/Paragraph.CYSbAqwQ.js">
		<link rel="modulepreload" href="../../_app/immutable/chunks/LinksList.Cw5MOKHz.js">
		<link rel="modulepreload" href="../../_app/immutable/chunks/CodeBlock.B9bDcqW8.js"><!--[--><meta name="description" content="Today I learned how to run integration tests on Phoenix controllers"> <link rel="canonical" href="/today-i-learned/how_to_test_phoenix_controllers/"> <meta name="keywords" content="rails, ruby, typescript, react, elixir, rust"> <meta name="twitter:image" content="https://rukomoynikov.com/_app/immutable/assets/facebook_cover_1200x630.D6J1q_ov.jpg?h=630&amp;w=1200"> <meta name="robots" content="index,follow"> <meta name="googlebot" content="index,follow"> <meta name="twitter:card" content="summary_large_image"> <meta name="twitter:site" content="@MRukomoynikov"> <meta name="twitter:description" content="Today I learned how to run integration tests on Phoenix controllers"> <meta name="twitter:image" content="https://rukomoynikov.com/_app/immutable/assets/facebook_cover_1200x630.D6J1q_ov.jpg?h=630&amp;w=1200"> <meta property="og:title" content="Test Phoenix controllers"> <meta property="og:description" content="Today I learned how to run integration tests on Phoenix controllers"> <meta property="og:image:url" content="https://rukomoynikov.com/_app/immutable/assets/facebook_cover_1200x630.D6J1q_ov.jpg?h=630&amp;w=1200"> <meta property="og:image:width" content="1200"> <meta property="og:image:height" content="630"> <meta property="og:image:alt" content="Test Phoenix controllers"> <meta property="og:url" content="/today-i-learned/how_to_test_phoenix_controllers/"> <meta property="og:type" content="website"> <meta property="og:site_name" content="Test Phoenix controllers"><!--]--><title>Test Phoenix controllers</title>
	</head>
	<body data-sveltekit-preload-data="hover">
		<div style="display: contents"><!--[--><!--[--><!----><div class="container--1200 svelte-1i3ol08"><!----><div class="columns standard svelte-1usoguu"><div class="col-1 svelte-1usoguu"><!----><h1 class="svelte-1ckgkw7"><a href="/" class="svelte-1ckgkw7">Max Rukomoynikov</a></h1> <div>I love to create. Developer and designer. Looking forward to make cool things.</div><!----></div> <!--[!--><!--]--></div><!----></div><!----> <!----><div class="container--1200 svelte-1i3ol08"><!----><!----><h1 class="null svelte-hffrw8"><!----><!---->Trigger Phoenix controllers from mix tasks<!----><!----></h1><!----><!----> <div class="columns standard svelte-1usoguu"><div class="col-1 svelte-1usoguu"><!----><p class="paragraph svelte-5wsfqn"><!----><!---->On of my projects needs to receive files from outside, like for example being uploaded from
			Github CI and I'd like to simulate this behaviour on my local machine. So, I needed a mix task
			which I will trigger and it would upload a file to the application.<!----></p><!----> <p class="paragraph svelte-5wsfqn"><!----><!---->Easiest way would be to start the application in one terminal tab and trigger this mix task in
			another.But Phoenix has all needed to make these both tasks simultanesly. In other words mix
			tasks can start up your application and shut it down when it's finished.<!----></p><!----><!----></div> <!--[--><div class="col-2 svelte-1usoguu"><!----><div slot="aside"><ul class="links-list svelte-5n4j8k"><!--[--><li class="svelte-5n4j8k"><a href="https://codemetrics.dev" class="links-list__link svelte-5n4j8k">CodeMetrics - home for your development metrics</a></li><!--]--></ul><!----></div><!----></div><!--]--></div><!----> <!----><h2 class="null svelte-hffrw8"><!----><!---->Application part<!----><!----></h2><!----><!----> <div class="columns standard svelte-1usoguu"><div class="col-1 svelte-1usoguu"><!----><!--[--><div class="codeBlock svelte-1cmzv5q "><button class="copyButton svelte-1cmzv5q ">Copy</button> <!--[!--><!--]--> <!----><pre class="shiki dark-plus" style="background-color: #1E1E1E" tabindex="0"><code><span class="line"><span style="color: #C586C0">defmodule</span><span style="color: #D4D4D4"> </span><span style="color: #4EC9B0">AppForArticleWeb</span><span style="color: #D4D4D4">.</span><span style="color: #4EC9B0">PageController</span><span style="color: #D4D4D4"> </span><span style="color: #C586C0">do</span></span>
<span class="line"><span style="color: #D4D4D4">  </span><span style="color: #C586C0">use</span><span style="color: #D4D4D4"> </span><span style="color: #4EC9B0">AppForArticleWeb</span><span style="color: #D4D4D4">, :controller</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D4D4D4">  </span><span style="color: #C586C0">def</span><span style="color: #D4D4D4"> </span><span style="color: #DCDCAA">home</span><span style="color: #D4D4D4">(conn, %{</span><span style="color: #CE9178">&quot;id&quot;</span><span style="color: #D4D4D4"> =&gt; id}) </span><span style="color: #C586C0">do</span></span>
<span class="line"><span style="color: #D4D4D4">    text conn, </span><span style="color: #CE9178">&quot;Showing id </span><span style="color: #569CD6">#{</span><span style="color: #D4D4D4">id</span><span style="color: #569CD6">}</span><span style="color: #CE9178">&quot;</span></span>
<span class="line"><span style="color: #D4D4D4">  </span><span style="color: #C586C0">end</span></span>
<span class="line"><span style="color: #C586C0">end</span></span>
<span class="line"></span></code></pre><!----></div><!--]--><!----></div> <!--[!--><!--]--></div><!----> <div class="columns standard svelte-1usoguu"><div class="col-1 svelte-1usoguu"><!----><p class="paragraph svelte-5wsfqn"><!----><!---->Just for the sake of explanation I will keep it simple. Just a controller action that accepts
			get request with one query parameter.<!----></p><!----></div> <!--[!--><!--]--></div><!----> <!----><h2 class="null svelte-hffrw8"><!----><!---->Mix task<!----><!----></h2><!----><!----> <div class="columns standard svelte-1usoguu"><div class="col-1 svelte-1usoguu"><!----><!--[--><div class="codeBlock svelte-1cmzv5q "><button class="copyButton svelte-1cmzv5q ">Copy</button> <!--[!--><!--]--> <!----><pre class="shiki dark-plus" style="background-color: #1E1E1E" tabindex="0"><code><span class="line"><span style="color: #C586C0">defmodule</span><span style="color: #D4D4D4"> </span><span style="color: #4EC9B0">Mix</span><span style="color: #D4D4D4">.</span><span style="color: #4EC9B0">Tasks</span><span style="color: #D4D4D4">.</span><span style="color: #4EC9B0">UploadDevReport</span><span style="color: #D4D4D4"> </span><span style="color: #C586C0">do</span></span>
<span class="line"><span style="color: #D4D4D4">  </span><span style="color: #C586C0">use</span><span style="color: #D4D4D4"> </span><span style="color: #4EC9B0">Mix</span><span style="color: #D4D4D4">.</span><span style="color: #4EC9B0">Task</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D4D4D4">  </span><span style="color: #9CDCFE">@shortdoc</span><span style="color: #D4D4D4"> </span><span style="color: #CE9178">&quot;Uploads a development report to the local server&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D4D4D4">  </span><span style="color: #9CDCFE">@impl</span><span style="color: #D4D4D4"> </span><span style="color: #4EC9B0">Mix</span><span style="color: #D4D4D4">.</span><span style="color: #4EC9B0">Task</span></span>
<span class="line"><span style="color: #D4D4D4">  </span><span style="color: #C586C0">def</span><span style="color: #D4D4D4"> </span><span style="color: #DCDCAA">run</span><span style="color: #D4D4D4">(</span><span style="color: #6A9955">_args</span><span style="color: #D4D4D4">) </span><span style="color: #C586C0">do</span></span>
<span class="line"><span style="color: #D4D4D4">    </span><span style="color: #DCDCAA">start_backend</span><span style="color: #D4D4D4">()</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D4D4D4">    %</span><span style="color: #4EC9B0">Req</span><span style="color: #D4D4D4">.</span><span style="color: #4EC9B0">Response</span><span style="color: #D4D4D4">{body: body} = </span><span style="color: #4EC9B0">Req</span><span style="color: #D4D4D4">.</span><span style="color: #DCDCAA">get!</span><span style="color: #D4D4D4">(</span><span style="color: #CE9178">&quot;http://localhost:4000?id=1&quot;</span><span style="color: #D4D4D4">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D4D4D4">    </span><span style="color: #4EC9B0">IO</span><span style="color: #D4D4D4">.</span><span style="color: #DCDCAA">puts</span><span style="color: #D4D4D4">(body)</span></span>
<span class="line"><span style="color: #D4D4D4">  </span><span style="color: #C586C0">end</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D4D4D4">  </span><span style="color: #C586C0">defp</span><span style="color: #D4D4D4"> </span><span style="color: #DCDCAA">phoenix_running?</span><span style="color: #D4D4D4">(address, port) </span><span style="color: #C586C0">do</span></span>
<span class="line"><span style="color: #D4D4D4">    </span><span style="color: #C586C0">case</span><span style="color: #D4D4D4"> :gen_tcp.</span><span style="color: #DCDCAA">connect</span><span style="color: #D4D4D4">(</span><span style="color: #DCDCAA">to_char_list</span><span style="color: #D4D4D4">(address), port, [:binary, active: </span><span style="color: #569CD6">false</span><span style="color: #D4D4D4">], </span><span style="color: #B5CEA8">1000</span><span style="color: #D4D4D4">) </span><span style="color: #C586C0">do</span></span>
<span class="line"><span style="color: #D4D4D4">      {:ok, </span><span style="color: #6A9955">_</span><span style="color: #D4D4D4">} -&gt; </span><span style="color: #569CD6">true</span></span>
<span class="line"><span style="color: #D4D4D4">      {:error, </span><span style="color: #6A9955">_</span><span style="color: #D4D4D4">} -&gt; </span><span style="color: #569CD6">false</span></span>
<span class="line"><span style="color: #D4D4D4">    </span><span style="color: #C586C0">end</span></span>
<span class="line"><span style="color: #D4D4D4">  </span><span style="color: #C586C0">end</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D4D4D4">  </span><span style="color: #C586C0">defp</span><span style="color: #D4D4D4"> </span><span style="color: #DCDCAA">start_backend</span><span style="color: #D4D4D4"> </span><span style="color: #C586C0">do</span></span>
<span class="line"><span style="color: #D4D4D4">    </span><span style="color: #C586C0">case</span><span style="color: #D4D4D4"> </span><span style="color: #DCDCAA">phoenix_running?</span><span style="color: #D4D4D4">(</span><span style="color: #CE9178">&quot;localhost&quot;</span><span style="color: #D4D4D4">, </span><span style="color: #B5CEA8">4000</span><span style="color: #D4D4D4">) </span><span style="color: #C586C0">do</span></span>
<span class="line"><span style="color: #D4D4D4">      </span><span style="color: #569CD6">false</span><span style="color: #D4D4D4"> -&gt;</span></span>
<span class="line"><span style="color: #D4D4D4">        </span><span style="color: #4EC9B0">Application</span><span style="color: #D4D4D4">.</span><span style="color: #DCDCAA">put_env</span><span style="color: #D4D4D4">(:phoenix, :serve_endpoints, </span><span style="color: #569CD6">true</span><span style="color: #D4D4D4">, persistent: </span><span style="color: #569CD6">true</span><span style="color: #D4D4D4">)</span></span>
<span class="line"><span style="color: #D4D4D4">        </span><span style="color: #4EC9B0">Mix</span><span style="color: #D4D4D4">.</span><span style="color: #4EC9B0">Task</span><span style="color: #D4D4D4">.</span><span style="color: #DCDCAA">run</span><span style="color: #D4D4D4">(</span><span style="color: #CE9178">&quot;app.start&quot;</span><span style="color: #D4D4D4">, [])</span></span>
<span class="line"><span style="color: #D4D4D4">      </span><span style="color: #569CD6">true</span><span style="color: #D4D4D4"> -&gt;</span></span>
<span class="line"><span style="color: #D4D4D4">        </span><span style="color: #4EC9B0">Mix</span><span style="color: #D4D4D4">.</span><span style="color: #4EC9B0">Task</span><span style="color: #D4D4D4">.</span><span style="color: #DCDCAA">run</span><span style="color: #D4D4D4">(</span><span style="color: #CE9178">&quot;app.start&quot;</span><span style="color: #D4D4D4">, [])</span></span>
<span class="line"><span style="color: #D4D4D4">    </span><span style="color: #C586C0">end</span></span>
<span class="line"><span style="color: #D4D4D4">  </span><span style="color: #C586C0">end</span></span>
<span class="line"><span style="color: #C586C0">end</span></span>
<span class="line"></span></code></pre><!----></div><!--]--><!----></div> <!--[!--><!--]--></div><!----> <div class="columns standard svelte-1usoguu"><div class="col-1 svelte-1usoguu"><!----><p class="paragraph svelte-5wsfqn"><!----><!---->The mix task itself is relatively simple as well. I just check if TCP server is running. If
			not it starts the application. Main part is taken from the Phoenix github repo.<!----></p><!----></div> <!--[--><div class="col-2 svelte-1usoguu"><!----><div slot="aside"><ul class="links-list svelte-5n4j8k"><!--[--><li class="svelte-5n4j8k"><a href="https://github.com/phoenixframework/phoenix/blob/3b64d58322ab2cb4bdaf6cb9662b84170b9bafeb/lib/mix/tasks/phx.server.ex#L31" class="links-list__link svelte-5n4j8k">Elixir github repo</a></li><!--]--></ul><!----></div><!----></div><!--]--></div><!----><!----></div><!----><!----><!----><!--]--> <!--[!--><!--]--><!--]-->
			
			<script>
				{
					__sveltekit_1zzyvq = {
						base: new URL("../..", location).pathname.slice(0, -1)
					};

					const element = document.currentScript.parentElement;

					Promise.all([
						import("../../_app/immutable/entry/start.B7qkGNvi.js"),
						import("../../_app/immutable/entry/app.CLiriMFa.js")
					]).then(([kit, app]) => {
						kit.start(app, element, {
							node_ids: [0, 9],
							data: [null,null],
							form: null,
							error: null
						});
					});
				}
			</script>
		</div>
	</body>
</html>
